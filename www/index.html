<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <title>EggLedger</title>
    <link rel="icon" href="images/icon-64.png" />
    <link rel="stylesheet" href="index.css" />
    <link rel="stylesheet" href="custom.css" />
    <script src="vue.global.prod.js"></script>
    <script src="shortcuts.js"></script>
  </head>
  <body>
    <div id="app" class="h-stretch">
      <!-- Set display to none initially and reset it once mounted to avoid flash of unrendered template. -->
      <div v-unhide class="h-stretch flex flex-col space-y-3 pb-3 bg-darker" style="display: none">
        <div class="h-11 flex-shrink-0 bg-dark">
          <div
            class="h-full flex items-end max-w-10xl w-full mx-auto px-4 space-x-1.5 bg-dark border-b border-gray-300"
          >
            <div
              v-for="tab in [UITab.Ledger, UITab.ViewData, UITab.About]"
              v-bind:key="tab"
              class="relative -bottom-px px-4 pt-1.5 pb-1 text-sm font-medium text-gray-400 border border-darker_tab border-300 rounded-t-md"
              v-bind:class="tab === activeTab ? 'bg-dark_tab border-b-transparent' : 'bg-darker_tab hover:bg-dark_tab_hover cursor-pointer'"
              v-on:click="activeTab = tab"
            >
              {{ tab }}
            </div>
          </div>
        </div>

        <div
          v-if="appIsInForbiddenDirectory || appIsTranslocated"
          v-show="activeTab === UITab.Ledger"
          class="flex-1 flex flex-col max-w-10xl w-full mx-auto px-4 space-y-3 overflow-y-scroll bg-darker"
        >
          <div class="text-sm text-gray-400 space-y-1">
            <template v-if="appIsTranslocated">
              <p class="text-red-700">
                EggLedger.app was launched in a jailed environment due to a macOS security feature.
                The app cannot write data to disk in this environment. To work around this, run the
                <span class="text-indigo-700">preflight</span> script which came with the app, then
                restart the app. See <span class="text-indigo-700">README.html</span> (also came
                with the app) for details.
              </p>
            </template>

            <template v-else>
              <p class="text-red-700">
                You app is located in <span class="text-indigo-700">{{ appDirectory }}</span>. The
                app stores all its data relative to itself, which would pollute this shared folder.
                Please close this window, create a separate folder for EggLedger, move the app into
                it, and try again.
              </p>
              <p>See "Where does EggLedger store data?" in the About tab for more details.</p>
            </template>
          </div>
        </div>

        <div
          v-else
          v-show="activeTab === UITab.Ledger"
          class="flex-1 flex flex-col max-w-10xl w-full mx-auto px-4 space-y-3 overflow-hidden bg-darker"
        >
          <div>
            <form
              id="ledgerForm"
              name="ledgerForm"
              class="mt-1 flex rounded-md shadow-sm"
              v-on:submit="event => {
              event.preventDefault();
              closePlayerIdDropdown();
              fetchPlayerData();
            }">
              <div ref="playerIdSelectRef" class="relative flex-grow focus-within:z-10">
                <!-- Overlay to tag the input with the corresponding nickname (if the playerId in the input is known). -->
                <div
                  v-if="nicknameForSelectedPlayerId"
                  class="absolute top-0 left-0 w-full px-3 py-2 truncate border border-transparent text-sm text-gray-300 tabular-nums"
                  style="z-index: -20"
                >
                  <span class="invisible whitespace-pre">{{ playerId }}</span> ({{
                  nicknameForSelectedPlayerId }})
                </div>

                <input
                  ref="playerIdInputRef"
                  type="text"
                  class="focus:ring-blue-500 text-gray-400 focus:border-blue-500 block w-full rounded-none rounded-l-md text-sm border-gray-300 bg-darkerer tabular-nums"
                  placeholder="EI1234567890123456"
                  v-bind:value="playerId"
                  v-on:focus="openPlayerIdDropdown"
                  v-on:input="playerId = $event.target.value"
                />

                <ul
                  v-if="playerIdDropdownOpen && knownAccounts.length > 0"
                  class="absolute z-10 mt-1 w-full bg-darkerer shadow-lg max-h-60 rounded-md py-1 text-gray-400 ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm"
                  tabindex="-1"
                >
                  <li
                    v-for="account in knownAccounts"
                    v-bind:key="account.id"
                    class="text-sm text-gray-400 hover:text-gray-300 hover:bg-blue-500 cursor-pointer select-none relative py-1 pl-3 tabular-nums"
                    v-on:click="selectPlayerId(account.id)"
                  >
                    {{ account.id }} ({{ account.nickname }})
                  </li>
                </ul>
              </div>
              <button
                v-if="idle"
                ref="playerIdSubmitRef"
                type="submit"
                class="-ml-px relative w-20 text-center space-x-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-r-md text-gray-400 bg-darkerer hover:bg-dark_tab_hover disabled:opacity-50 disabled:hover:darker_tab_hover disabled:hover:cursor-not-allowed focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                v-bind:disabled="playerId.trim() === ''"
              >
                Fetch
              </button>
              <button
                v-else
                type="button"
                class="-ml-px relative w-20 text-center space-x-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-r-md text-gray-400 bg-darkerer hover:bg-dark_tab_hover disabled:opacity-50 disabled:hover:darker_tab_hover disabled:hover:cursor-not-allowed focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                v-on:click="stopFetchingPlayerData(); refreshExistingExports();"
              >
                Stop
              </button>
            </form>
          </div>

          <div class="h-14 px-2 py-1 text-xs text-gray-500 bg-darkest rounded-md tabular-nums">
            <template v-if="currentState === AppState.FetchingSave">Fetching save...</template>
            <template v-else-if="currentState === AppState.FetchingMissions">
              <div>
                Fetching missions...<br />
                {{ missionProgress.finished }}/{{ missionProgress.total }}, ETA {{
                missionProgress.eta }}
              </div>
              <div class="h-3 relative rounded-full overflow-hidden mt-1">
                <div class="w-full h-full bg-gray-200 absolute"></div>
                <div
                  class="h-full absolute rounded-full bg-green-500"
                  v-bind:style="{ width: missionProgress.finishedPercentage }"
                ></div>
              </div>
            </template>
            <template v-else-if="currentState === AppState.ExportingData"
              >Exporting data...</template
            >
            <template v-else-if="currentState === AppState.Success">
              Successfully exported to:
              <div class="grid gap-x-2" style="grid-template-columns: repeat(2, max-content)">
                <template v-for="file in exportedFiles" v-bind:key="file">
                  <button
                    class="text-green-500 hover:text-green-600 underline"
                    v-on:click="openFile(file)"
                  >
                    {{ file }}
                  </button>
                  <button
                    class="text-blue-500 hover:text-blue-600 underline truncate"
                    v-on:click="openFileInFolder(file)"
                  >
                    open in folder
                  </button>
                </template>
              </div>
            </template>
            <template v-else-if="currentState === AppState.Failed">
              Data fetching failed. Please try again.<br />
            </template>
            <template v-else-if="currentState === AppState.Interrupted">Interrupted.</template>
          </div>

          <div
            ref="messagesRef"
            class="flex-1 px-2 py-1 overflow-auto shadow-sm block text-xs font-mono text-gray-400 bg-darkest rounded-md"
          >
            <div v-for="(message, i) in messages" v-bind:key="i" class="whitespace-pre">
              <span v-bind:class="message.isError ? 'text-red-700' : 'text-green-700'"
                >{{ hhmmss(message.timestamp) }}|</span
              >
              {{ message.content }}
            </div>
          </div>
        </div>

        <div
          v-show="activeTab === UITab.About"
          class="flex-1 max-w-10xl w-full mx-auto px-4 overflow-y-auto"
        >
          <div class="text-sm text-gray-400 space-y-2">
            <p class="space-x-3">
              <a
                v-external-link
                href="https://github.com/DavidArthurCole/EggLedger/releases"
                target="_blank"
                class="text-green-500 hover:text-green-600 underline"
                >Check for updates</a
              >
              <a
                v-external-link
                href="https://wasmegg-carpet.netlify.app/"
                target="_blank"
                class="text-green-500 hover:text-green-600 underline"
                >More tools</a
              >
            </p>

            <hr />
            <div class="space-y-1">
              <h2 class="font-bold">Is mk2 back?</h2>
              <span class="mt-1">No. This tool is now being developed independently of mk2 - the community has taken over his orphaned tools since he went AWOL in 2022. <i>For EggLedger</i>, <i>specifically</i>, I  (<a
                v-external-link
                href="https://github.com/DavidArthurCole"
                target="_blank"
                class="text-gray-500 hover:text-gray-600 underline"
                >DavidArthurCole</a
              >) am the active developer and maintainer. To report issues, ask for changes, and more generally, to reach me with any information, reach out on discord <span class="text-short">@davidarthurcole</span>, or <a 
                v-external-link
                href="https://github.com/DavidArthurCole/EggLedger/issues/new/choose"
                target="_blank"
                class="text-gray-500 hover:text-gray-600 underline"
              >open an Issue on GitHub</a>.</span>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">What does EggLedger do?</h2>
              <p>
                EggLedger helps export your spaceship mission data, including loot from each
                mission, to .xlsx (Excel) and .csv formats for further analysis. It is an extension
                to the
                <a
                  v-external-link
                  href="https://wasmegg-carpet.netlify.app/rockets-tracker/"
                  target="_blank"
                  class="text-blue-500 hover:text-blue-600 underline"
                  >rockets tracker</a
                >, answering questions like "from which mission did I obtain this legendary
                artifact?" and "how many of this item dropped from my ships?" which can't be
                answered there due to technical or UI limitations.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">How do I use EggLedger?</h2>
              <p>
                Go to the Ledger tab, enter your Egg, Inc. account ID (not to be confused with your
                nickname), and press "Fetch". First session for an account could take a while,
                proportional to the number of missions you have completed. Subsequent sessions will
                only fetch unrecorded missions.
                <span class="underline">Data for multiple accounts can coexist.</span>
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">When I use EggLedger, are my data shared with anyone?</h2>
              <p>
                No. EggLedger communicates with the Egg, Inc. API directly, meaning all your data is
                kept 100% private. No data or analytics is collected by the EggLedger developer. The
                only third party request is the occasional update check against github.com; this is
                the biggest open source code hosting service, there is no personal data attached to
                the requests and no logs are available to me. Unless you tell me over another
                channel, there's no way I can determine if you're even using this tool, let alone
                acquiring collecting any info about your account.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Are there risks to my account if I use EggLedger?</h2>
              <p>
                I'm not aware of any negative effects, and
                <a
                  v-external-link
                  href="https://wasmegg-carpet.netlify.app/rockets-tracker/"
                  target="_blank"
                  class="text-blue-500 hover:text-blue-600 underline"
                  >rockets tracker</a
                >
                has been safely operating with the same techniques for a very long time. Do realize
                that none of my tools are sanctioned by the Egg, Inc. developer, so you use them at
                your own risk. I'm not responsible for any negative effects.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Where do I find my Egg, Inc. account ID?</h2>
              <p>
                Open the game menu
                <img
                  src="images/icon_menu.webp"
                  alt="Menu Icon"
                  class="bg-white inline h-5 w-5 p-0.5 relative -top-px border border-gray-300 rounded-full"
                />
                (lower left corner), choose Settings
                <img
                  src="images/icon_settings.webp"
                  alt="Settings Icon"
                  class="bg-white inline h-5 w-5 relative -top-px border border-gray-300 rounded-full"
                />, then click on "Privacy & Data". Your ID is at the bottom.
                <span class="underline">It should look like EI1234567890123456</span>; that's the
                letters "EI" followed by 16 digits.
              </p>
              <p>
                Alternatively, if you choose Help
                <img
                  src="images/icon_help.webp"
                  alt="Help Icon"
                  class="bg-white inline h-5 w-5 relative -top-px border border-gray-300 rounded-full"
                />
                in the main menu and click on "Data Loss Issue", the game will auto-compose an email
                with your ID in the subject.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Why are my latest missions missing?</h2>
              <p>
                The server backup is probably out of date. Pay attention to the message printed
                about the freshness of your backup whenever your backup is fetched.
              </p>
              <p>
                The game, while active, backs up your game state to Egg, Inc.'s server every couple
                of minutes if network condition allows, but these are mostly unpredictable.
                <span class="underline"
                  >Force closing and reopening the game, or switching to another farm, can fairly
                  reliably trigger a new backup.</span
                >
              </p>
              <p>
                However, even after an app-initiated backup, it may take an unpredictable amount of
                time (usually no longer than a minute or two) for the game server to serve the
                updated backup through its API. EggLedger won't see the missions until then.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Where does EggLedger store data?</h2>
              <p>
                All configurations, data, and exported files are stored in the same directory as the
                EggLedger application.
                <span class="underline"
                  >Make sure you put EggLedger in a directory of its own, and don't touch the
                  "internal" directory</span
                >
                (or you risk data corruption). If you want to uninstall EggLedger, just delete the
                directory, and it won't leave any trace on your system.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Where do I get @mk2's autograph?</h2>
              <p>
                <a
                  v-external-link
                  href="https://areyousure.netlify.app/"
                  target="_blank"
                  class="text-blue-500 hover:text-blue-600 underline"
                  >Are you sure</a
                >
                you want @mk2's autograph?
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Known issues</h2>
              <p>Since this application piggybacks on Chrome, there are a few known limitations:</p>
              <ul class="list-decimal list-inside">
                <li>On macOS, clicking on the app in dock can open a new browser window.</li>
                <li>On Windows, resolution of the task bar app icon is garbage.</li>duration
              </ul>
            </div>
            <hr />
          </div>
        </div>

        <div class="flex-1 flex flex-col max-w-10xl w-full mx-auto px-4 space-y-3 overflow-auto shadow-sm block"
          v-show="activeTab === UITab.ViewData">
          <div id="missionViewDiv" ref="missionViewDiv" style="height: 100vh; width: 100vw;" class="z-40 fixed top-0 left-0 right-0 bottom-0 hidden items-center justify-center overlay">
            <div id="innerMissionViewDiv" style="padding: 1rem;" style="max-height: 80vw;"  class="bg-dark rounded-lg relative"> <!-- I couldn't get this fucker to pad with p-1rem, I fucking hate tailwind -->
              <button class="absolute top-2 right-2 text-gray-300  hover:text-gray-300" v-on:click="closeOverlay()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
              <div id="missionViewContentDiv" v-if="(viewMissionData && viewMissionData != {} && viewMissionData.shipInfo != null)" 
                style="max-height: 70vh; max-width: 35vw; min-width: 30vw;" class="text-gray-300 text-center overflow-auto">
                <!-- Header information about the mission -->
                <span :class="durToTextClass(viewMissionData.shipInfo.durationType)">{{ shipToName(viewMissionData.shipInfo.ship) }}</span><br />
                <span class="text-star text-goldenstar" v-if="viewMissionData.shipInfo.level && viewMissionData.shipInfo.level > 0">{{ "★".repeat(viewMissionData.shipInfo.level) }}</span>
                <br v-if="viewMissionData.shipInfo.level && viewMissionData.shipInfo.level > 0" />
                Launched: {{ viewMissionData.launchStr }} <br />
                Returned: {{ viewMissionData.returnStr }} <br />
                Duration: {{ viewMissionData.durationStr }} <br />
                Capacity: {{ viewMissionData.shipInfo.capacity }} <br />
                <div v-if="viewMissionData.shipInfo.target != '' && viewMissionData.shipInfo.target.toUpperCase() != 'UNKNOWN'">
                  <div class="items-center justify-center flex">
                    <span>Sensor Target: </span>
                    <div style="margin-left: 0.3rem;" class="text-center text-xs rounded-full w-max px-1.5 py-0.5 text-gray-400 bg-darkerer font-semibold">
                      {{ properCase(viewMissionData.shipInfo.target.replace("_", " ")) }}
                    </div>
                  </div>
                  <br/>
                </div>
                <!-- Previous mission -->
                <button v-bind:disabled="viewMissionData.prevMission == null" v-on:click="viewSpecificMission(viewMissionData.prevMission)"
                class="disabled:hover:cursor-not-allowed absolute left-0 top-1/2 transform -translate-y-1/2 pl-2 rounded-md text-gray-400 focus:outline-none z-10 disabled:text-gray-500 hover:text-gray-500">
                  <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <!-- Next mission -->
                <button v-bind:disabled="viewMissionData.nextMission == null" v-on:click="viewSpecificMission(viewMissionData.nextMission)"
                class="disabled:hover:cursor-not-allowed absolute right-0 top-1/2 transform -translate-y-1/2 pr-2 rounded-md text-gray-400 focus:outline-none z-10 disabled:text-gray-500 hover:text-gray-500">
                  <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>

                <!-- Artifacts -->
                <div v-if="viewMissionData.artifactCount > 0">
                  <div class="mission-view-div bg-blue-900">
                    Artifacts ({{ viewMissionData.artifactCount }})
                  </div>
                  <div style="max-width: 20vw;" class="flex flex-wrap justify-center mx-auto">
                    <div class="mission-view-rep" v-for="(af, afindex) in viewMissionData.artifacts">
                      <a v-external-link :class="'tooltip-custom relative block h-full w-full rounded-full ' + afBackgroundClass(af)" 
                        target="_blank" :href="'https://wasmegg-carpet.netlify.app/artifact-explorer/#/artifact/' + afExplorerName(af, 1) + '/'">
                        <img class="h-full w-full" :alt="af.gameName" :src="specPath(af, 1)"/>
                        <div v-if="af.count > 1" :class="'mission-view-af-count-div ' + numToDigClass(af.count)">
                          {{ af.count }}
                        </div>
                        <span class="text-sm tooltiptext-custom speech-bubble">
                          {{ af.gameName }} (T{{parseInt(af.level) + 1}})
                          <span :class="afRarityClass(af)">
                            {{ afRarityText(af) }}
                          </span>
                          × {{ af.count }} <br />
                          {{ boundEffectString(af.effectString)[0] }}
                          <span class="text-sm text-green-500">
                            {{ boundEffectString(af.effectString)[1] }}
                          </span>
                          {{ boundEffectString(af.effectString)[2] }}
                        </span>
                      </a>
                    </div>
                  </div>
                  <br />
                </div>

                <!-- Stones -->
                <div v-if="viewMissionData.stoneCount > 0">
                  <div class="mission-view-div bg-fuchsia-900">
                    Eggfinity Stones ({{ viewMissionData.stoneCount }})
                  </div>
                  <div style="max-width: 20vw;" class="flex flex-wrap justify-center mx-auto">
                    <div class="mission-view-rep" v-for="(st, stindex) in viewMissionData.stones">
                      <a v-external-link class="tooltip-custom relative block h-full w-full rounded-full bg-darker" 
                        target="_blank" :href="'https://wasmegg-carpet.netlify.app/artifact-explorer/#/artifact/' + afExplorerName(st, 2) + '/'">
                        <img class="h-full w-full" :alt="st.gameName" :src="specPath(st, 2)"/>
                        <div v-if="st.count > 1" :class="'mission-view-af-count-div ' + numToDigClass(st.count)">
                          {{ st.count }}
                        </div>
                        <span class="text-sm tooltiptext-custom speech-bubble">
                          {{ st.gameName }} (T{{parseInt(st.level) + 2}})
                          × {{ st.count }} <br />
                          {{ boundEffectString(st.effectString)[0] }}
                          <span class="text-sm text-green-500">
                            {{ boundEffectString(st.effectString)[1] }}
                          </span>
                          {{ boundEffectString(st.effectString)[2] }}
                        </span>
                      </a>
                    </div>
                  </div>
                  <br />
                </div>

                <!-- Ingredients -->
                <div v-if="viewMissionData.ingredientCount > 0">
                  <div class="mission-view-div text-gray-400 bg-darkerer">
                    Ingredients ({{ viewMissionData.ingredientCount }})
                  </div>
                  <div style="max-width: 20vw;" class="flex flex-wrap justify-center mx-auto">
                    <div class="mission-view-rep" v-for="(ing, ingindex) in viewMissionData.ingredients">
                      <a v-external-link class="tooltip-custom relative block h-full w-full rounded-full bg-darker" 
                        target="_blank" :href="'https://wasmegg-carpet.netlify.app/artifact-explorer/#/artifact/' + afExplorerName(ing, 1) + '/'">
                        <img class="h-full w-full" :alt="ing.gameName" :src="specPath(ing, 1)"/>
                        <div v-if="ing.count > 1" :class="'mission-view-af-count-div ' + numToDigClass(ing.count)">
                          {{ ing.count }}
                        </div>
                        <span class="text-sm tooltiptext-custom speech-bubble">
                          {{ ing.gameName }} (T{{parseInt(ing.level) + 1}})
                          × {{ ing.count }}
                        </span>
                      </a>
                    </div>
                  </div>
                  <br />
                </div>

                <!-- Stone Fragments -->
                <div v-if="viewMissionData.stoneFragmentCount > 0">
                  <div class="mission-view-div text-gray-400 bg-darkerer">
                    Stone Fragments ({{ viewMissionData.stoneFragmentCount }})
                  </div>
                  <div style="max-width: 20vw;" class="flex flex-wrap justify-center mx-auto">
                    <div class="mission-view-rep" v-for="(sf, sfindex) in viewMissionData.stoneFragments">
                      <a v-external-link class="tooltip-custom relative block h-full w-full rounded-full bg-darker" 
                        target="_blank" :href="'https://wasmegg-carpet.netlify.app/artifact-explorer/#/artifact/' + afExplorerName(sf, 1) + '/'">
                        <img class="h-full w-full" :alt="sf.gameName" :src="specPath(sf, 1)"/>
                        <div v-if="sf.count > 1" :class="'mission-view-af-count-div ' + numToDigClass(sf.count)">
                          {{ sf.count }}
                        </div>
                        <span class="text-sm tooltiptext-custom speech-bubble">
                          {{ sf.gameName }} (T{{parseInt(sf.level) + 1}})
                          × {{ sf.count }} <br />
                      </a>
                    </div>
                    <br />
                  </div>
                </div>

                <!-- Shamelessly stolen straight from MK2's source code, with mobile note removed -->
                <div class="mt-2 text-xs text-gray-300 text-center">
                  Hover mouse over an item to show details.<br />
                  Click to open the relevant <a target="_blank" v-external-link href="https://wasmegg-carpet.netlify.app/artifact-explorer/" class="underline">
                    artifact explorer
                  </a> page.
                </div>

                <!-- End mission view-->
              </div>
            </div>
          </div>
          <div ref="selectViewAccountForm" v-if="doesExportExist">
            <form id="viewAccountForm" name="viewAccountForm" class="mt-1 flex rounded-md shadow-sm"
              v-on:submit="event => {
                event.preventDefault();
                viewEidGo();
                topLevelFilterOptions.value = [null];
                filterOperators.value = [null];
                filterValues.value = [null];
                updateFilterConditionsCount();
              }">
              <div class="relative flex-grow focus-within:z-10">
                <label for="view-file-sel" class="sr-only">Choose an account</label>
                <select class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-none rounded-l-md text-sm text-gray-400 border-gray-300 bg-darkest tabular-nums appearance-none"
                  id="view-file-sel" ref="view-file-sel" v-model="selectedAccount">
                  <option v-bind:key="account" v-bind:value="null" >Choose an account</option>
                  <option v-for="account in readableExistingExports" v-bind:key="account" v-bind:value="account.id">
                    {{ account.nickname }}  ({{ account.missionCount }} missions)
                </select>
              </div>
              <button class="-ml-px relative w-20 text-center space-x-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-r-md text-gray-400 filter-button"
              v-if="idle" ref="viewAccountSubmitRef" type="submit" v-bind:disabled="(selectedAccount === null || eidBeingLoaded)">
                View
              </button>
            </form>
          </div>
          <div class="text-center mt-3rem" ref="noDataToView" v-else>
            <span class="text-red-700"> No mission data has been loaded yet.<br>Please '<span class="font-bold text-gray-400">Fetch</span>' from the </span><button type="button" class="btn-link" onclick="switchToLedger()" ><span class="text-blue-500 underline font-bold">Ledger tab</span></button><span class="text-red-700"> and then come back here.</span>
          </div>
          <div v-if="groupedMissions && Object.keys(groupedMissions).length > 0 || (filteredMissions != null && allLoadedMissions != null && Object.keys(filteredMissions).length != Object.keys(allLoadedMissions).length)">
            <div class="mt-1rem" style="margin-bottom: 1rem;" v-if="selectedAccount != null && selectedAccount == loadedEid && loadedAccountMissionsCount != (readableExistingExports.find(acc => acc.id == selectedAccount)?.missionCount ?? 0)">
              <span class="text-red-700 border border-red-700 rounded-md mb-1 py-2 px-4"> You are viewing outdated data - click <span class="text-gray-500">View</span> again to fix this.</span>
            </div>
            <div ref="filterRef">
              <span class="font-bold text-gray-400">Filter:</span> <button id="toggleFilterButton" class="text-base text-short mr-5 font-bold btn btn-outline-dark bg-transparent" type="button" onclick="toggleFilter()">Hide</button>
              <form id="filterForm" name="filterForm" v-if="!hideFilter"
              class="mt-05rem flex-1 px-2 py-1 shadow-sm block text-xs font-mono text-gray-500 bg-darkest rounded-md"
              v-on:submit="event => {
                event.preventDefault();
                applyFilter();
              }">
                <div class="relative flex-grow" v-for="(item, index) in generateFilterConditionsArr()" :key="index">
                  <!-- Separator -->
                  <div v-if="index != 0" class="text-gray-400 mt-05rem">-- AND --</div>

                  <div class="relative flex flex-row items-center flex-grow focus-within:z-10">
                    <!-- Top level filter options -->
                    <select class="focus:ring-blue-500 focus:border-blue-500 block rounded-md text-sm text-gray-400 border-gray-300 bg-darkest tabular-nums appearance-none mr-1rem mt-05rem"
                      onchange="if(this.oldValue == null) { updateFilterConditionsCount(); this.oldValue = this.value;} else { updateFilterNoReCount(); } updateValueStyling(this);"
                      v-model="topLevelFilterOptions[index]">
                      <option v-for="validOption in getTopLevelFilterOptions()" v-bind:key="validOption" v-bind:value="validOption.value">
                        {{ validOption.text }}
                    </select>

                    <!-- Operator options -->
                    <select class="focus:ring-blue-500 focus:border-blue-500 block rounded-md text-sm text-gray-400 border-gray-300 bg-darkest tabular-nums appearance-none mr-1rem mt-05rem"
                      onchange="if(this.oldValue == null) { updateFilterConditionsCount(); this.oldValue = this.value;} else { updateFilterNoReCount(); } updateValueStyling(this);"
                      v-if="topLevelFilterOptions[index] != null" v-model="filterOperators[index]">
                      <option v-for="validOperator in getFilterOpOptions(topLevelFilterOptions[index])" v-bind:key="validOperator" v-bind:value="validOperator.value">
                        {{ validOperator.text }}
                    </select>

                    <!-- Value options -->
                    <select class="focus:ring-blue-500 focus:border-blue-500 block rounded-md text-sm text-gray-400 border-gray-300 bg-darkest tabular-nums appearance-none mr-1rem mt-05rem"
                      onchange="if(this.oldValue == null) { updateFilterConditionsCount(); this.oldValue = this.value;} else { updateFilterNoReCount();} updateValueStyling(this);"
                      v-if="topLevelFilterOptions[index] != null && filterOperators[index] != null && topLevelFilterOptions[index] != 'launchDT' && topLevelFilterOptions[index] != 'returnDT'"
                      v-model="filterValues[index]">
                      <option v-for="validValue in getFilterValueOptions(topLevelFilterOptions[index])" :class="validValue.styleClass ?? ''" v-bind:key="validValue" v-bind:value="validValue.value">
                        {{ validValue.text }}
                    </select>
                    <!-- Launch/Return Date Selectors - 
                      Min: 20 January 2021  
                      Max: Today-->
                    <input type="date" min="2021-01-20" :max="new Date().toISOString().split('T')[0]" v-model="filterValues[index]"
                      class="focus:ring-blue-500 focus:border-blue-500 block rounded-md text-sm text-gray-400 border-gray-300 bg-darkest tabular-nums appearance-none mr-1rem mt-05rem"
                      v-if="topLevelFilterOptions[index] != null && filterOperators[index] != null && (topLevelFilterOptions[index] == 'launchDT' || topLevelFilterOptions[index] == 'returnDT')"
                      onchange="if(this.oldValue == null) { updateFilterConditionsCount(); this.oldValue = this.value;} else { updateFilterNoReCount();} updateValueStyling(this);"
                      v-bind:disabled="topLevelFilterOptions[index + 1] != null">
                    <button style="margin-right: 1rem;" type="button" v-on:click="addOr(index)"
                      title="Add alternate filter condition"
                      class="flex items-center h-6 w-6 justify-center text-sml border text-yellow-700 border-yellow-700 bg-darkest rounded-md bg-transparent py-2 px-4 mt-05rem filter-button"
                      v-if="topLevelFilterOptions[index] != null && filterOperators[index] != null && filterValues[index] != null"
                      v-bind:disabled="orFilterConditionsCount[index] != null && orFilterConditionsCount[index] != 0 && (orFilterTopLevelOptions[index][orFilterConditionsCount[index] - 1] == null || orFilterOperators [index][orFilterConditionsCount[index] - 1] == null || orFilterValues[index][orFilterConditionsCount[index] - 1] == null)">
                      OR
                    </button>
                    <!-- Clear button-->
                    <button 
                      v-if="topLevelFilterOptions[index] != null"
                      style="margin-right: 1rem;"
                      class="flex items-center justify-center text-red-700 text-lg w-6 h-6 border border-red-700 rounded-md bg-transparent mt-05rem filter-button"
                      title="Remove filter condition"
                      v-on:click="removeAndShift(index)">
                      ×
                    </button>
                    <!-- Show a warning div if the filter is incomplete -->
                    <span
                      v-if="topLevelFilterOptions[index] != null && (filterOperators[index] == null || filterValues[index] == null)"
                      class="tooltip-custom items-center justify-center text-red-700 text-sml border border-red-700 rounded-md bg-transparent py-2 px-4 mt-05rem">
                      (!)
                      <span class="tooltiptext-custom speech-bubble text-sml text-gray-500">This filter condition is incomplete,<br/>and will not be applied.</span>
                    </span>
                  </div>
                  <div class="ml-2rem relative flex flex-row items-center flex-grow focus-within:z-10" 
                    v-if="orFilterConditionsCount[index] != null && orFilterConditionsCount[index] > 0"
                    v-for="(orItem, orIndex) in generateOrFiltersConditionsArr(index)">
                      <!-- Separator -->
                      <div class="text-gray-400 mt-05rem mr-1rem"><span class="text-gray text-lg">⮡ </span> OR</div>

                      <!-- Top level filter options -->
                      <select v-model="orFilterTopLevelOptions[index][orIndex]"
                        class="focus:ring-blue-500 focus:border-blue-500 block rounded-md text-sm text-gray-400 border-gray-300 bg-darkest tabular-nums appearance-none mr-1rem mt-05rem"
                        onchange="updateFilterNoReCount();">
                        <option v-for="validOption in getTopLevelFilterOptions()" v-bind:key="validOption" v-bind:value="validOption.value">
                          {{ validOption.text }}
                      </select>
                      <!-- Operator options -->
                      <select
                        v-if="orFilterTopLevelOptions[index][orIndex] != null" v-model="orFilterOperators[index][orIndex]"
                        class="focus:ring-blue-500 focus:border-blue-500 block rounded-md text-sm text-gray-400 border-gray-300 bg-darkest tabular-nums appearance-none mr-1rem mt-05rem"
                        onchange="updateFilterNoReCount();">
                        <option v-for="validOperator in getFilterOpOptions(orFilterTopLevelOptions[index][orIndex])" v-bind:key="validOperator" v-bind:value="validOperator.value">
                          {{ validOperator.text }}
                      </select>

                      <!-- Value options -->
                      <select v-model="orFilterValues[index][orIndex]"
                        v-if="orFilterTopLevelOptions[index][orIndex] != null && orFilterOperators[index][orIndex] != null && orFilterTopLevelOptions[index][orIndex] != 'launchDT' && orFilterTopLevelOptions[index][orIndex] != 'returnDT'"
                        class="focus:ring-blue-500 focus:border-blue-500 block rounded-md text-sm text-gray-400 border-gray-300 bg-darkest tabular-nums appearance-none mr-1rem mt-05rem"
                        onchange="updateFilterNoReCount();">
                        <option v-for="validValue in getFilterValueOptions(orFilterTopLevelOptions[index][orIndex])" :class="validValue.styleClass ?? ''" v-bind:key="validValue" v-bind:value="validValue.value">
                          {{ validValue.text }}
                      </select>
                      <!-- Launch/Return Date Selectors - 
                        Min: 20 January 2021  
                        Max: Today + 5 days -->
                      <input type="date" min="2021-01-20" :max="new Date().toISOString().split('T')[0]" v-model="orFilterValues[index][orIndex]"
                        class="focus:ring-blue-500 focus:border-blue-500 block rounded-md text-sm text-gray-400 border-gray-300 bg-darkest tabular-nums appearance-none mr-1rem mt-05rem"
                        v-if="orFilterTopLevelOptions[index][orIndex] != null && orFilterOperators[index][orIndex] != null && (orFilterTopLevelOptions[index][orIndex] == 'launchDT' || orFilterTopLevelOptions[index][orIndex] == 'returnDT')"
                        onchange="updateFilterNoReCount();"
                      >
                      <!-- Clear button-->
                      <button 
                        v-if="orFilterTopLevelOptions[index][orIndex] != null"
                        style="margin-right: 1rem;"
                        class="flex items-center justify-center text-red-700 text-lg w-6 h-6 border border-red-700 rounded-md bg-transparent mt-05rem filter-button"
                        title="Remove filter condition"
                        v-on:click="removeOrAndShift(index, orIndex)">
                        ×
                      </button>
                      <!-- Show a warning div if the filter is incomplete -->
                      <span
                        v-if="orFilterTopLevelOptions[index][orIndex] != null && (orFilterOperators[index][orIndex] == null || orFilterValues[index][orIndex] == null)"
                        class="tooltip-custom items-center justify-center text-red-700 text-sml border border-red-700 rounded-md bg-transparent py-2 px-4 mt-05rem">
                        (!)
                        <span class="tooltiptext-custom speech-bubble text-sml text-gray-500">This filter condition is incomplete,<br/>and will not be applied.</span>
                      </span>
                  </div>
                </div>

                <!-- Create a 2 px visible gray line that goes across the entire div-->
                <hr class="mt-1rem w-full">

                <button
                  v-if="idle"
                  ref="applyFilterToData"
                  type="submit"
                  class="mt-05rem mr-1rem -ml-px relative p-0.5 text-center space-x-2 px-3 py-1 border border-gray-300 text-sm font-medium rounded-md text-gray-400 bg-darkerer hover:bg-dark_tab_hover disabled:opacity-50 disabled:hover:darker_tab_hover disabled:hover:cursor-not-allowed focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                  v-bind:disabled="(dataFilter === [] || dataBeingFiltered || !filterHasChanged)"
                >
                  Apply Filter
                </button>
                <!-- Show the time that it took to apply the filter -->
                <span v-if="filterApplyTime != ''" class="filter-button text-green-700 mt-05rem">
                  <i>
                    Filtered in {{ filterApplyTime }} <span class="text-gray-500">
                      ( <span class="text-green-700">
                        {{ filteredMissions.length }} shown, {{ allLoadedMissions.length - filteredMissions.length }} filtered out 
                      </span>)
                    </span>
                  </i>
                </span>
              </form>
            </div>
            <hr class="mt-1rem invisible">
            <div ref="resultsDiv">
              <span class="font-bold text-gray-400">Missions: </span>
              <button v-if="filteredMissions.length != 0" id="toggleResultsButton" class="text-base text-short mr-5 font-bold btn btn-outline-dark bg-transparent" type="button" v-on:click="toggleAll($event)">Hide All</button>
              <label for="viewByDateCB" class="text-gray-400 mr-05rem">Separate missions by day</label>
              <input id="viewByDateCB" type="checkbox" v-model="viewByDate" checked
                class="text-gray-400 rounded-full rounded-md bg-darkest hover:bg-darkerer focus:ring-blue-500 focus:border-blue-500"/>
              <div class="mt-05rem flex-1 px-2 py-1 shadow-sm block text-lg font-mono text-gray-500 bg-darkest rounded-md" v-if="filteredMissions.length == 0">
                <span class="mt-05rem ml-1rem">No missions to display.</span>
              </div>
              <div v-else class="mt-05rem flex-1 px-2 py-1 shadow-sm block text-xs font-mono text-gray-500 bg-darkest rounded-md">
                <div v-for="(value, yIndex) in groupedMissions" :key="yIndex">
                  <span :class="'text-lg font-bold underline y-header-' + yIndex">{{ yIndex }}</span> <button class="toggleButton text-lg text-short mr-5 font-bold btn btn-outline-dark bg-transparent" type="button" v-on:click="toggleYear($event, yIndex)">Hide</button>
                  <div :class="'mt-1 all-targetable-closeable year-' + yIndex + '-child'" 
                    v-for="(subValue, mIndex) in value" :key="mIndex">
                    <div class="mt-1rem ml-2rem">
                      <span class="text-base font-bold underline">{{ yIndex }}-{{ mIndex }}</span> <button class="toggleButton text-base text-short mr-5 font-bold btn btn-outline-dark bg-transparent" type="button" v-on:click="toggleMonth($event, yIndex, mIndex)">Hide</button>
                      <div :class="'all-targetable-closeable year-' + yIndex + '-child-' + mIndex" v-for="(subSubValue, dIndex) in subValue" :key="dIndex">
                        <!-- View with date-->
                        <div v-if="viewByDate" class="mt-1rem ml-2rem">
                          <span class="text-sm font-bold underline">{{ yIndex }}-{{ mIndex }}-{{ dIndex }}</span> <button class="toggleButton text-sm text-short mr-5 font-bold btn btn-outline-dark bg-transparent" type="button" v-on:click="toggleDay($event, yIndex, mIndex, dIndex)">Hide</button>
                          <div class="mt-1rem mission-grid">
                            <div :class="'text-sm mission-item all-targetable-closeable year-' + yIndex + '-child-' + mIndex + '-' + dIndex" 
                              v-for="(mission, missionIndex) in subSubValue" :key="missionIndex">
                              <button 
                                class="text-sm mr-5 font-bold btn btn-outline-dark bg-transparent"
                                type="button"
                                v-on:click="viewSpecificMission(mission.missionId)">
                                <span class="text-gray-300" v-html="mission.launchTime + '  ' + durToSpan(mission.durationType, shipToName(mission.ship)) + '  ' + levelToStars(mission.level) + targetImage(mission.target)"></span>
                              </button>
                            </div>
                          </div>                        
                        </div>
                        <!-- View without date-->
                        <div v-else class="mt-1rem ml-2rem">
                          <div class="mt-1rem mission-grid">
                            <div :class="'text-sm mission-item all-targetable-closeable year-' + yIndex + '-child-' + mIndex + '-' + dIndex" 
                              v-for="(mission, missionIndex) in subSubValue" :key="missionIndex">
                              <button 
                                class="text-sm mr-5 font-bold btn btn-outline-dark bg-transparent"
                                type="button"
                                v-on:click="viewSpecificMission(mission.missionId)">
                                <span class="text-gray-300" v-html="mission.launchTime + '  ' + durToSpan(mission.durationType, shipToName(mission.ship)) + '  ' + levelToStars(mission.level) + targetImage(mission.target)"></span>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <hr :class="'pt-3rem pb-3rem invisible mt-1 all-targetable-closeable year-' + yIndex + '-child'">
                </div>
              </div>
            </div>
          </div>
          
        </div>

        <footer class="text-center text-sm text-gray-500">
          <a
            v-external-link
            href="https://github.com/DavidArthurCole/EggLedger"
            target="_blank"
            class="text-gray-500 hover:text-gray-600 underline"
            >EggLedger</a
          >
          v{{ appVersion }} by @<a
            v-external-link
            href="https://github.com/fanaticscripter"
            target="_blank"
            class="text-gray-500 hover:text-gray-600 underline"
            >mk2</a
          > & @<a
            v-external-link
            href="https://github.com/DavidArthurCole"
            target="_blank"
            class="text-gray-500 hover:text-gray-600 underline"
            >DavidArthurCole</a
          >
          <span v-if="appHasUpdate" class="text-red-700">
            (<a
              v-external-link
              href="https://github.com/DavidArthurCole/EggLedger/releases"
              target="_blank"
              class="text-red-700 hover:text-red-800 underline"
              >new version available!</a
            >)</span
          >
        </footer>
      </div>
    </div>

    <script>
      // Global bindings from the go side:
      // - appVersion()
      // - appDirectory()
      // - appIsInForbiddenDirectory()
      // - appIsTranslocated()
      // - knownAccounts()
      // - fetchPlayerData(playerId string)
      // - stopFetchingPlayerData()
      // - openFile(file string)
      // - openFileInFolder(file string)
      // - openURL(url string)
      // - checkForUpdates()

      //Daveed additions :^)
      // - doesExportExist(): bool
      // - getExistingExports(): []string

      // Interrupt worker if the page is reloaded or closed.
      window.addEventListener('beforeunload', async () => {
        await window.stopFetchingPlayerData();
      });

      (async function () {
        const appVersion = await window.appVersion();
        const appDirectory = await window.appDirectory();
        const appIsInForbiddenDirectory = await window.appIsInForbiddenDirectory();
        const appIsTranslocated = await window.appIsTranslocated();
        const previouslyKnownAccounts = (await window.knownAccounts()) ?? [];

        const UITab = {
          Ledger: 'Ledger',
          ViewData: 'View Mission Data',
          About: 'About',
        };

        const AppState = {
          AwaitingInput: 'AwaitingInput',
          FetchingSave: 'FetchingSave',
          FetchingMissions: 'FetchingMissions',
          ExportingData: 'ExportingData',
          Success: 'Success',
          Failed: 'Failed',
          Interrupted: 'Interrupted',
        };

        function normalizePlayerId(id) {
          id = id.trim();
          if (id.match(/^EI[0-9]{16}$/i)) {
            return id.toUpperCase();
          }
          return id;
        }

        function isIdle(state) {
          return ![
            AppState.FetchingSave,
            AppState.FetchingMissions,
            AppState.ExportingData,
          ].includes(state);
        }

        function hhmmss(date) {
          const hh = date.getHours().toString().padStart(2, '0');
          const mm = date.getMinutes().toString().padStart(2, '0');
          const ss = date.getSeconds().toString().padStart(2, '0');
          return `${hh}:${mm}:${ss}`;
        }

        function toggleAll(event){
          const self = event.target;
          const newState = (self.innerHTML === "Hide All") ? "none" : "block";
          //Switch self to ▼ or ▶
          self.innerHTML = (self.innerHTML === "Show All") ? "Hide All" : "Show All";
          //Switch `toggleButton` class elements to `Show` or `Hide`
          const bChildren = document.querySelectorAll(".toggleButton");
          for (const child of bChildren) {
            child.innerHTML = (self.innerHTML === "Show All") ? "Show" : "Hide";
          }
          //Get all `all-targetable-closeable` class elements
          const children = document.querySelectorAll(".all-targetable-closeable");
          for (const child of children) {
            child.style.display = newState;
          }
        }

        function toggleYear(event, year) {
          const self = event.target;
          const newState = (self.innerHTML === "Hide") ? "none" : "block";
          //Switch self to ▼ or ▶
          self.innerHTML = (self.innerHTML === "Show") ? "Hide" : "Show";
          //Hide or show all direct children (year-x-child)
          const children = document.querySelectorAll(".year-" + year + "-child");
          for (const child of children) {
            child.style.display = newState;
          }
        };

        function toggleMonth(event, year, month){
          const self = event.target;
          const newState = (self.innerHTML === "Hide") ? "none" : "block";
          //Switch self to ▼ or ▶
          self.innerHTML = (self.innerHTML === "Show") ? "Hide" : "Show";
          //Hide or show all direct children (year-x-child)
          const children = document.querySelectorAll(".year-" + year + "-child-" + month);
          for (const child of children) {
            child.style.display = newState;
          }
        };

        function toggleDay(event, year, month, day){
          const self = event.target;
          const newState = (self.innerHTML === "Hide") ? "none" : "block";
          //Switch self to ▼ or ▶
          self.innerHTML = (self.innerHTML === "Show") ? "Hide" : "Show";
          //Hide or show all direct children (year-x-child)
          const children = document.querySelectorAll(".year-" + year + "-child-" + month + "-" + day);
          for (const child of children) {
            child.style.display = newState;
          }
        };

        function durToSpan(duration, shipName){
          if(duration === "" || duration === null || duration === undefined){
            return "";
          }else{
            switch(duration){
              case 0: return `<span class="text-short">` + shipName + `</span>`;
              case 1: return `<span class="text-standard">` + shipName + `</span>`;
              case 2: return `<span class="text-extended">` + shipName + `</span>`;
              case 3: return `<span class="text-tutorial">` + shipName + `</span>`;
              default: return `<span style="color: red">` + shipName + `</span>`;
            }
          }
        }

        function durToName(dur){
          if(dur === "" || dur === null || dur === undefined){
            return "";
          }else{
            switch(dur){
              case 0: return "Short";
              case 1: return "Standard";
              case 2: return "Extended";
              case 3: return "Tutorial";
              default: return "Unknown";
            }
          }
        }

        function shipToName(ship){
          if(ship === "" || ship === null || ship === undefined){
            return "";
          }else{
            switch(ship){
              case 0: return "Chicken One";
              case 1: return "Chicken Nine";
              case 2: return "Chicken Heavy";
              case 3: return "BCR";
              case 4: return "Quintillion Chicken";
              case 5: return "Cornish-Hen Corvette";
              case 6: return "Galeggtica";
              case 7: return "Defihent";
              case 8: return "Voyegger";
              case 9: return "Henerprise";
              default: return "Unknown";
            }
          }
        }

        function levelToStars(level){
          return level <= 0 ? "" : `(` + level + `<span style="color: gold;">★</span>)`;
        }

        function getTopLevelFilterOptions(){
          return [
            { text: 'Ship', value: 'ship' },
            { text: 'Duration', value: 'duration' },
            { text: 'Level', value: 'level' },
            { text: 'Target', value: 'target' },
            { text: 'Drops/Loot', value: 'drops' },
            { text: 'Launch Date', value: 'launchDT' },
            { text: 'Return Date', value: 'returnDT' }
          ]
        }

        function getFilterOpOptions(topLevel){
          switch(topLevel){
            case 'ship':
            case 'duration':
            case 'level': return [
              { text: 'is', value: '=' },
              { text: 'is not', value: '!=' },
              { text: 'greater than', value: '>' },
              { text: 'less than', value: '<' }
            ];
            case 'target': return [
              { text: 'is', value: '=' },
              { text: 'is not', value: '!=' }
            ];
            case 'drops': return [
              { text: 'contains', value: 'c' },
              { text: 'does not contain', value: 'dnc' }
            ];
            case 'launchDT':
            case 'returnDT':
              return [
                { text: 'on', value: 'on' },
                { text: 'before', value: 'before' },
                { text: 'after', value: 'after' }
              ]
          }
        }

        function getFilterValueOptions(topLevel){
          switch(topLevel){
            case 'ship': return Array.from({ length: 10 }, (_, index) => ({
                text: shipToName(index),
                value: index,
              }));
            case 'duration': return Array.from({ length: 4 }, (_, index) => ({
                text: durToName(index),
                value: index,
                styleClass: generateDurStyleClass(index)
              }));
            case 'level': return Array.from({ length: 8 }, (_, index) => ({
                text: index + '★',
                value: index
              }));
            case 'target': return possibleTargets.map(target => ({
                text: target.displayName,
                value: target.id
              }));
            case 'drops': {
              const filteredConfigs = artifactConfigs.filter(a => a.baseQuality <= maxQuality).map(artifact => ({
                text: artifact.displayName + ((artifact.level == '%') ? '' : (' (T' + (artifact.level + ((artifact.displayName.toLowerCase().indexOf('stone') > -1 && artifact.displayName.toLowerCase().indexOf('fragment') == -1) ? 2 : 1)) + ')')),
                value: artifact.name + "_" + artifact.level + "_" + artifact.rarity + "_" + artifact.baseQuality,
                styleClass: generateDropStyleClass(artifact)
              }))
              filteredConfigs.unshift({text: 'Any Legendary', value: '%_%_3_%', styleClass: 'text-legendary'});
              filteredConfigs.unshift({text: 'Any Epic', value: '%_%_2_%', styleClass: 'text-epic'});
              filteredConfigs.unshift({text: 'Any Rare', value: '%_%_1_%', styleClass: 'text-rare'});   
              return filteredConfigs;
            }
          }
        }

        function generateDurStyleClass(dur){
          switch(dur){
            case 0: return 'text-short';
            case 1: return 'text-standard';
            case 2: return 'text-extended';
            case 3: return 'text-tutorial';
            default: return '';
          }
        }

        function generateDropStyleClass(drop){
          switch(drop.rarity){
            case 0: return 'text-gray-400';
            case 1: return 'text-rare';
            case 2: return 'text-epic';
            case 3: return 'text-legendary';
            default: return 'text-gray-400';
          }
        }

        window.updateValueStyling = (passedEl) => {
          //Extract the index from the element's id (split on the last dash)
          const index = parseInt(passedEl.id.split("-").pop());
          const el = document.getElementById('filter-value-' + index);
          if(el == null) return;
          const existingBorder = 'border-' + el.classList.toString().match(/ border-(.*?)(\s|"|'|$)/)[1].trim();
          const existingText = 'text-' + el.classList.toString().replace('text-sm', '').match(/ text-(.*?)(\s|"|'|$)/)[1].trim();
          var newBorder = '', newText = '';
          if(topLevelFilterOptions[index] == 'drops' && el.value != ''){
            switch(el.value.split("_")[2]){
              case "0": newBorder = 'border-gray-300'; newText = 'text-gray-400'; break;
              case "1": newBorder = 'border-rare'; newText = 'text-rare'; break;
              case "2": newBorder = 'border-epic'; newText = 'text-epic'; break;
              case "3": newBorder = 'border-legendary'; newText = 'text-legendary'; break;
              default: newBorder = 'border-gray-300'; newText = 'text-gray-400'; break;
            }
          } else if(topLevelFilterOptions[index] == 'duration' && el.value != ''){
            switch(el.value){
              case "0": newBorder = 'border-short'; newText = 'text-short'; break;
              case "1": newBorder = 'border-standard'; newText = 'text-standard'; break;
              case "2": newBorder = 'border-extended'; newText = 'text-extended'; break;
              case "3": newBorder = 'border-tutorial'; newText = 'text-tutorial'; break;
              default: newBorder = 'border-gray-300'; newText = 'text-gray-400'; break;
            }
          } else {
            newBorder = 'border-gray-300';
            newText = 'text-gray-400';
          }
          el.classList.remove(existingBorder);
          el.classList.add(newBorder);
          el.classList.remove(existingText);
          el.classList.add(newText);
        }

        const app = Vue.createApp({
          setup() {
            // ===== Tab =====
            const activeTab = Vue.ref(UITab.Ledger);

            // ===== Player ID input and dropdown =====
            const knownAccounts = Vue.ref(previouslyKnownAccounts);
            const playerId = Vue.ref(previouslyKnownAccounts[0]?.id ?? '');
            const nicknameForSelectedPlayerId = Vue.computed(() => {
              const id = normalizePlayerId(playerId.value);
              for (const account of knownAccounts.value) {
                if (account.id === id) {
                  return account.nickname;
                }
              }
              return null;
            });
            const playerIdSelectRef = Vue.ref(null);
            const playerIdInputRef = Vue.ref(null);
            const playerIdSubmitRef = Vue.ref(null);
            const playerIdDropdownOpen = Vue.ref(false);
            const openPlayerIdDropdown = () => {
              playerIdDropdownOpen.value = true;
            };
            const closePlayerIdDropdown = () => {
              playerIdDropdownOpen.value = false;
              if (playerId.value.trim() !== '' && playerIdSubmitRef.value !== null) {
                playerIdSubmitRef.value.focus();
              } else {
                playerIdInputRef.value?.blur();
              }
            };
            const selectPlayerId = id => {
              playerId.value = id;
              closePlayerIdDropdown();
            };
            // Close dropdown when clicking or focusing elsewhere.
            const handleMousedown = event => {
              const target = event.target;
              if (!playerIdSelectRef.value?.contains(target)) {
                closePlayerIdDropdown();
              }
            };
            const handleFocus = () => {
              const active = document.activeElement;
              if (!playerIdSelectRef.value?.contains(active)) {
                closePlayerIdDropdown();
              }
            };
            Vue.onMounted(() => {
              window.addEventListener('mousedown', handleMousedown);
              window.addEventListener('focus', handleFocus, true);
            });
            Vue.onUnmounted(() => {
              window.removeEventListener('mousedown', handleMousedown);
              window.removeEventListener('focus', handleFocus);
            });

            const isFetching = Vue.ref(false);
            const fetchPlayerData = async () => {
              const normalizedId = normalizePlayerId(playerId.value);
              if (normalizedId !== '') {
                isFetching.value = true;
                await window.fetchPlayerData(normalizedId);
                isFetching.value = false;
              }
            };

            const stopFetchingPlayerData = async () => {
              await window.stopFetchingPlayerData();
              isFetching.value = false;
            };

            // ===== App state =====
            const currentState = Vue.ref(AppState.AwaitingInput);
            const idle = Vue.computed(() => isIdle(currentState.value));

            const missionProgress = Vue.ref({
              total: 0,
              finished: 0,
              finishedPercentage: '0%',
              expectedFinishTimestamp: 0,
              eta: '',
            });
            const getEta = finish => {
              const eta = Math.round(Math.max(finish - Date.now() / 1000, 0));
              const h = Math.floor(eta / 3600).toString();
              const mm = Math.floor((eta % 3600) / 60)
                .toString()
                .padStart(2, '0');
              const ss = Math.floor(eta % 60)
                .toString()
                .padStart(2, '0');
              return `${h}:${mm}:${ss}`;
            };
            let etaIntervalId;
            Vue.onMounted(() => {
              etaIntervalId = setInterval(() => {
                missionProgress.value.eta = getEta(missionProgress.value.expectedFinishTimestamp);
              }, 200);
            });
            Vue.onUnmounted(() => clearInterval(etaIntervalId));

            const exportedFiles = Vue.ref([]);

            // ===== Messages buffer =====
            const messages = Vue.ref([]);
            // Auto scroll messaged buffer to bottom, but only if the user hasn't scrolled up manually.
            const messagesRef = Vue.ref(null);
            const messagesScrolledUp = Vue.ref(false);
            // Check if user scrolled up, before the content changes.
            Vue.watch(
              messages,
              () => {
                const textarea = messagesRef.value;
                messagesScrolledUp.value =
                  textarea.scrollTop + textarea.clientHeight < textarea.scrollHeight;
              },
              { deep: true }
            );
            // Conditionally scroll to bottom after the content changes.
            Vue.watch(
              messages,
              () => {
                const textarea = messagesRef.value;
                if (!messagesScrolledUp.value) {
                  textarea.scrollTop = textarea.scrollHeight;
                }
              },
              { deep: true, flush: 'post' }
            );

            // ===== Check for updates =====
            const appHasUpdate = Vue.ref(false);
            Vue.onMounted(async () => {
              appHasUpdate.value = await window.checkForUpdates();
            });

            // ===== Global bindings =====
            // Bind a bunch of state updater functions to the global scope so that the go side can
            // push state updates.
            window.updateKnownAccounts = accounts => {
              knownAccounts.value = accounts;
            };
            window.updateState = newState => {
              currentState.value = newState;
            };
            window.updateMissionProgress = newProgress => {
              missionProgress.value = {
                ...newProgress,
                eta: getEta(newProgress.expectedFinishTimestamp),
              };
            };
            window.updateExportedFiles = newFiles => {
              exportedFiles.value = newFiles;
            };
            window.emitMessage = (content, isError) => {
              messages.value.push({
                timestamp: new Date(),
                content,
                isError,
              });
            };

            // ===== Setup for 'View Mission Data' Tab =====
            const viewByDate = Vue.ref(true);
            const viewMissionData = Vue.ref({});
            Vue.onMounted(() => {
              window.viewMissionData = viewMissionData.value;
            });
            Vue.watch(viewMissionData, () => {
              window.viewMissionData = viewMissionData.value;
            });
            const doesExportExist = Vue.ref(false);
            const existingExports = Vue.ref([]); //Empty array of strings
            const readableExistingExports = Vue.computed(() => {
              return existingExports.value.map(account => {
                return {
                  id: account.id,
                  nickname: account.nickname,
                  missionCount: account.missionCount
                };
              });
            });
            //Filter [ x ] that have the same `name`, `level`, `specType`, and `rarity`
            // If there are 2 artifacts with the same name, level, specType, and rarity, increment the `count` of the first one, and remove the second one
            const groupedSpecType = (collection) => {
              return collection.reduce((acc, obj) => {
                const key = obj.name + "_" + obj.level + "_" + obj.specType + "_" + obj.rarity;
                if (!acc[key]) {
                  acc[key] = obj;
                  acc[key].count = 1;
                }else{
                  acc[key].count++;
                }
                return acc;
              }, {});
            };
            const sortedGroupedSpecType = (collection) => {
              return Object.values(groupedSpecType(collection)).sort((a, b) => {
                if(a.level > b.level) return -1;
                if(a.level < b.level) return 1;
                if(a.rarity > b.rarity) return -1;
                if(a.rarity < b.rarity) return 1;
                if(a.quality < b.quality) return -1;
                if(a.quality > b.quality) return 1;
                return 0;
              }).reverse();
            };
            const numToDigClass = (num) => {
              const parsedNum = parseInt(num.toString());
              switch (true) {
                case parsedNum <= 9: return "w-onedig";
                case parsedNum > 9 && parsedNum <= 99: return "w-twodig";
                case parsedNum > 99: return "w-threedig";
                default: return "w-onedig";
              }
            };
            const properCase = (string) => {
              string = string.toLowerCase();
              //Capitalize the first letter of each word, unless it is 'of' or 'the'
              const words = string.split(" ");
              for (let i = 0; i < words.length; i++) {
                if(words[i] !== "of" && words[i] !== "the"){
                  words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1);
                }
              }
              return words.join(" ");
            };
            const boundEffectString = (str) => {
              const effRegex = /\[(.*?)\]/g;
              const match = effRegex.exec(str);
              if(!match) return ["?", "?", "?"];
              //Return three strings in an array, the first is the string before the effect, the second is the effect, and the third is the string after the effect
              return [str.substring(0, match.index), match[1], str.substring(match.index + match[0].length)];
            };
            const durToTextClass = (dur) => {
              switch(dur){
                case 0: return "text-short";
                case 1: return "text-standard";
                case 2: return "text-extended";
                case 3: return "text-tutorial";
                default: return "";
              }
            };
            const afRarityClass = (drop) => {
              if(drop.specType != 'Artifact') return "";
              switch(drop.rarity){
                case 1: return "text-rare";
                case 2: return "text-epic";
                case 3: return "text-legendary";
                default: return "";
              }
            };
            const afRarityText = (drop) => {
              if(drop.specType != 'Artifact') return "";
              switch(drop.rarity){
                case 1: return "Rare";
                case 2: return "Epic";
                case 3: return "Legendary";
                default: return "";
              }
            };
            const afBackgroundClass = (af) => {
              switch (af.rarity) {
                case 0: return 'bg-darkerer';
                case 1: return 'bg-rare';
                case 2: return 'bg-epic';
                case 3: return 'bg-legendary';
                default: return 'bg-darkerer';
              }
            };
            const afExplorerName = (drop, addend) => {
              return drop.name.replace('_FRAGMENT', '').toLowerCase().replace("_", "-") + '-' + (parseInt(drop.level) + addend);
            };
            const closeOverlay = () => {
              document.querySelector('.overlay').style.display = 'none';
              viewMissionData.value = {};
            };
            const openOverlay = () => {
              document.querySelector('.overlay').style.display = 'flex';
            };
            const specPath = (spec, addend) => {
              const fixedName = spec.name.replaceAll("_FRAGMENT", "").replaceAll("ORNATE_GUSSET", "GUSSET").replaceAll("VIAL_MARTIAN_DUST", "VIAL_OF_MARTIAN_DUST");
              return "images/artifacts/" + fixedName + "/" + fixedName + "_" + (parseInt(spec.level) + addend) + ".png";
            };
            const refreshExistingExports = async () => {
              doesExportExist.value = await window.doesExportExist();
              if(doesExportExist.value) {
                existingExports.value = await window.getExistingExports();
              }
            };
            Vue.watch((exportedFiles, knownAccounts, previouslyKnownAccounts, currentState), async () => {
              refreshExistingExports();
            });
            Vue.onMounted(async () => {
              refreshExistingExports();
            });

            window.switchToLedger = () => {
              activeTab.value = UITab.Ledger;
            };

            const possibleTargets = Vue.ref(null);
            Vue.onMounted(async () => {
              possibleTargets.value = JSON.parse(await window.getPossibleTargets());
              window.possibleTargets = possibleTargets.value;
            });

            const selectedAccount = Vue.ref(null);
            const eidBeingLoaded = Vue.ref(false);
            const loadedEid = Vue.ref(null);
            const loadedAccountMissionsCount = Vue.ref(0);
            const allLoadedMissions = Vue.ref(null);
            const filteredMissions = Vue.ref(null);
            const groupedMissions = Vue.computed(() => {
              if(filteredMissions.value == null || filteredMissions.value.length == 0) return {};
              return filteredMissions.value.reduce((acc, obj) => {
                const year = obj.launchYear;
                const month = obj.launchMonth;
                const day = obj.launchDay;

                if (!acc[year]) {
                  acc[year] = {};
                }
                if (!acc[year][month]) {
                  acc[year][month] = {};
                }
                if (!acc[year][month][day]) {
                  acc[year][month][day] = [];
                }

                // Add the new mission to the beginning of the array
                acc[year][month][day].unshift(obj);
                return acc;
              }, {});
            });

            const viewEidGo = async () => {
              loadedAccountMissionsCount.value = readableExistingExports.value.find(acc => acc.id == selectedAccount.value.toString())?.missionCount ?? 0;
              eidBeingLoaded.value = true;
              const loadValue = await window.viewEidGo(selectedAccount.value.toString());
              if (loadValue !== "") {
                allLoadedMissions.value = JSON.parse(loadValue);
                filteredMissions.value = allLoadedMissions.value;
                loadedEid.value = selectedAccount.value.toString();
              }
              eidBeingLoaded.value = false;
            };

            //==============================================
            // Filter stuff :^)
            //==============================================
            const filterApplyTime = Vue.ref(0);

            const filterConditionsCount = Vue.ref(1);
            const topLevelFilterOptions = Vue.ref([]);
            const filterOperators = Vue.ref([]);
            const filterValues = Vue.ref([]);

            const orFilterConditionsCount = Vue.ref([]);
            const orFilterTopLevelOptions = Vue.ref([[]]);
            const orFilterOperators = Vue.ref([[]]);
            const orFilterValues = Vue.ref([[]]);

            const dataFilter = Vue.ref([]);
            const orDataFilter = Vue.ref([[]]);
            const maxQuality = Vue.ref("");
            const durationConfigs = Vue.ref(null);
            const artifactConfigs = Vue.ref(null);
            const hideFilter = Vue.ref(false);
            const filterHasChanged = Vue.ref(false);
            const dataBeingFiltered = Vue.ref(false);

            // Vue computed/watched values
            Vue.watch(topLevelFilterOptions, () => {
              window.topLevelFilterOptions = topLevelFilterOptions.value;
            }, {deep: true});

            Vue.watch(orFilterTopLevelOptions, () => {
              window.orFilterTopLevelOptions = orFilterTopLevelOptions.value;
            }, {deep: true});

            Vue.onMounted(async () => {
              artifactConfigs.value = JSON.parse(await window.getAfxConfigs());
              window.artifactConfigs = artifactConfigs.value;
            });

            Vue.onMounted(async () => {
              maxQuality.value = JSON.parse(await window.getMaxQuality());
              window.maxQuality = maxQuality.value;
              durationConfigs.value = JSON.parse(await window.getDurationConfigs());
              window.durationConfigs = durationConfigs.value;
            });

            Vue.watch((dataFilter, orDataFilter), async () => {
              filterHasChanged.value = true;
            });

            //==============================================
            // Filter window functions
            //==============================================
            function generateFilterConditionsArr(){
              return new Array(filterConditionsCount.value);
            };

            function generateOrFiltersConditionsArr(index){
              return new Array(orFilterConditionsCount.value[index]);
            };

            window.manualChangeFilter = async () => {
              filterHasChanged.value = true;
            };

            window.updateFilterNoReCount = function() {
              filterHasChanged.value = true;
              const newDataFilter = [];
              if(topLevelFilterOptions.value.length != 0 && topLevelFilterOptions.value != null){
                for(let i = 0; i < topLevelFilterOptions.value.length; i++){
                const topLevel = topLevelFilterOptions.value[i];
                const op = filterOperators.value[i];
                const val = filterValues.value[i];
                if(topLevel == null || op == null || val == null) break;
                newDataFilter.push({
                  topLevel: topLevel,
                  op: op,
                  val: val
                });
              } 
              }
              dataFilter.value = newDataFilter;

              const newOrDataFilter = [];
              for(let i = 0; i < orFilterConditionsCount.value.length; i++){
                const orDataFilterArr = [];
                if(orFilterTopLevelOptions.value[i] == null || orFilterOperators.value[i] == null || orFilterValues.value[i] == null) continue;
                for(let j = 0; j < orFilterTopLevelOptions.value[i].length; j++){
                  const topLevel = orFilterTopLevelOptions.value[i][j];
                  const op = orFilterOperators.value[i][j];
                  const val = orFilterValues.value[i][j];
                  if(topLevel == null || op == null || val == null) break;
                  orDataFilterArr.push({
                    topLevel: topLevel,
                    op: op,
                    val: val
                  });
                }
                newOrDataFilter.push(orDataFilterArr);
              }
              orDataFilter.value = newOrDataFilter;
            };

            window.updateFilterConditionsCount = function() {
              filterHasChanged.value = true;
              const newDataFilter = [];
              if(topLevelFilterOptions.value.length == 0 || topLevelFilterOptions.value == null) return;
              var maxIndex = 0;
              var set = false;

              for(let i = 0; i < topLevelFilterOptions.value.length; i++){
                const topLevel = topLevelFilterOptions.value[i];
                const op = filterOperators.value[i];
                const val = filterValues.value[i];

                if(topLevel == null || op == null || val == null) {
                  maxIndex = i;
                  break;
                }

                newDataFilter.push({
                  topLevel: topLevel,
                  op: op,
                  val: val
                });

                if(i + 1 == filterConditionsCount.value) {
                  filterConditionsCount.value += 1;
                  set = true;
                }
              }

              if(!set) filterConditionsCount.value = maxIndex + 1;
              dataFilter.value = newDataFilter;
            };

            window.toggleFilter = function() {
              hideFilter.value = !hideFilter.value;
              document.getElementById('toggleFilterButton').innerHTML = hideFilter.value ? "Show" : "Hide";
            };

            
            //==============================================
            // Filter Vue functions
            //==============================================
            const addOr = (index) => {
              if(orFilterConditionsCount.value == null) {
                window.console.log("orFilterConditionsCount.value is null");
                orFilterConditionsCount.value = []
              };
              if(orFilterConditionsCount.value[index] == null) orFilterConditionsCount.value[index] = 1;
              else orFilterConditionsCount.value[index] += 1;

              if(orFilterTopLevelOptions.value[index] == null) orFilterTopLevelOptions.value[index] = [];
              if(orFilterOperators.value[index] == null) orFilterOperators.value[index] = [];
              if(orFilterValues.value[index] == null) orFilterValues.value[index] = [];

              orFilterTopLevelOptions.value[index].push(null);
              orFilterOperators.value[index].push(null);
              orFilterValues.value[index].push(null);
            };

            const removeAndShift = (index) => {
              //Shift all elements after the one being removed down one
              for(let i = index; i < topLevelFilterOptions.value.length; i++){
                topLevelFilterOptions.value[i] = topLevelFilterOptions.value[i + 1];
                filterOperators.value[i] = filterOperators.value[i + 1];
                filterValues.value[i] = filterValues.value[i + 1];
              
                orFilterConditionsCount.value[i] = orFilterConditionsCount.value[i + 1];
                orFilterTopLevelOptions.value[i] = orFilterTopLevelOptions.value[i + 1];
                orFilterOperators.value[i] = orFilterOperators.value[i + 1];
                orFilterValues.value[i] = orFilterValues.value[i + 1];
              }
              window.updateFilterConditionsCount();
              window.updateFilterNoReCount();
              filterHasChanged.value = true;
            }

            const removeOrAndShift = (index, orIndex) => {
              //Shift all elements after the one being removed down one
              for(let i = orIndex; i < orFilterTopLevelOptions.value[index].length; i++){
                orFilterTopLevelOptions.value[index][i] = orFilterTopLevelOptions.value[index][i + 1];
                orFilterOperators.value[index][i] = orFilterOperators.value[index][i + 1];
                orFilterValues.value[index][i] = orFilterValues.value[index][i + 1];
              }
              orFilterConditionsCount.value[index] -= 1;
              if(orFilterConditionsCount.value[index] == 0) orFilterConditionsCount.value[index] = null;
              window.updateFilterNoReCount();
              filterHasChanged.value = true;
            }

            const testMissionAgainstFilter = async(mission, filter) => {
              var filterPassed = true;
              if(filter.topLevel != null && filter.op != null && filter.val != null){
                switch(filter.topLevel){
                  case 'ship': {
                    switch(filter.op){
                      case '=': if(mission.ship != filter.val) filterPassed = false; break;
                      case '!=': if(mission.ship == filter.val) filterPassed = false; break;
                      case '>': if(mission.ship <= filter.val) filterPassed = false; break;
                      case '<': if(mission.ship >= filter.val) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'duration': {
                    switch(filter.op){
                      case '=': if(mission.durationType != filter.val) filterPassed = false; break;
                      case '!=': if(mission.durationType == filter.val) filterPassed = false; break;
                      case '>': if(mission.durationType <= filter.val) filterPassed = false; break;
                      case '<': if(mission.durationType >= filter.val) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'level': {
                    switch(filter.op){
                      case '=': if(mission.level != filter.val) filterPassed = false; break;
                      case '!=': if(mission.level == filter.val) filterPassed = false; break;
                      case '>': if(mission.level <= filter.val) filterPassed = false; break;
                      case '<': if(mission.level >= filter.val) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'target': {
                    switch(filter.op){
                      case '=': if(mission.targetInt != filter.val) filterPassed = false; break;
                      case '!=': if(mission.targetInt == filter.val) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'launchDT': {
                    const launchDay = mission.launchDay.toString().padStart(2, '0');
                    const launchMonth = mission.launchMonth.toString().padStart(2, '0');
                    const launchYear = mission.launchYear.toString().padStart(4, '0');
                    const launchDT = new Date(launchYear + "-" + launchMonth + "-" + launchDay);
                    const filterDT = new Date(filter.val);
                    switch(filter.op){
                      case 'on': if(launchDT.toDateString() != filterDT.toDateString()) filterPassed = false; break;
                      case 'before': if(launchDT >= filterDT) filterPassed = false; break;
                      case 'after': if(launchDT <= filterDT) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'returnDT': {
                    const returnDay = mission.returnDay.toString().padStart(2, '0');
                    const returnMonth = mission.returnMonth.toString().padStart(2, '0');
                    const returnYear = mission.returnYear.toString().padStart(4, '0');
                    const returnDT = new Date(returnYear + "-" + returnMonth + "-" + returnDay);
                    const filterDT = new Date(filter.val);
                    switch(filter.op){
                      case 'on': if(returnDT.toDateString() != filterDT.toDateString()) filterPassed = false; break;
                      case 'before': if(returnDT >= filterDT) filterPassed = false; break;
                      case 'after': if(returnDT <= filterDT) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'drops': {
                    const durConfig = durationConfigs.value[mission.ship].durations[mission.durationType];
                    const maxQuality = durConfig.maxQuality + (durConfig.levelQualityBump * mission.level);
                    const filterQuality = filter.val.split("_")[3]; const qualityBypass = (filterQuality == '%');
                    const filterRarity = filter.val.split("_")[2]; const rarityBypass = (filterRarity == '%');
                    const filterLevel = filter.val.split("_")[1]; const levelBypass = (filterLevel == '%');
                    const filterName = filter.val.split("_")[0]; const nameBypass = (filterName == '%');
                    const loadValue = await window.getShipDrops(loadedEid.value, mission.missionId);
                    if(loadValue == "") filterPassed = false;
                    const allDrops = JSON.parse(loadValue);
                    switch(filter.op){
                      case 'c':{ //Contains
                        var foundDrop = false;
                        if(!qualityBypass && maxQuality < filterQuality || !qualityBypass && durConfig.minQuality > filterQuality) filterPassed = false;
                        for(const drop of allDrops){
                          if(!nameBypass && parseInt(filterName) != drop.id ) continue;
                          if(!levelBypass && parseInt(filterLevel) != drop.level) continue;
                          if(!rarityBypass && parseInt(filterRarity) != drop.rarity) continue;
                          foundDrop = true;
                        }
                        if(!foundDrop) filterPassed = false;
                        break;
                      }
                      case 'dnc': { //Does not contain
                        for(const drop of allDrops){
                          if(!nameBypass && parseInt(filterName) != drop.id ) continue;
                          if(!levelBypass && parseInt(filterLevel) != drop.level) continue;
                          if(!rarityBypass && parseInt(filterRarity) != drop.rarity) continue;
                          filterPassed = false;
                        }
                      }
                    }
                  }
                }
                return filterPassed;
              } else return false;
            }

            const missionMatchesFilter = async (mission, filters, orFilters) => {
              var allFiltersPassed = true;
              var index = 0;
              for(const filter of filters){
                var filterPassed = true;
                if(filter.topLevel != null && filter.op != null && filter.val != null){
                  filterPassed = await testMissionAgainstFilter(mission, filter);
                  if(!filterPassed) {
                    if(orFilters[index] != null){
                      for(const orFilter of orFilters[index]){
                        if(orFilter.topLevel != null && orFilter.op != null && orFilter.val != null){
                          filterPassed = await testMissionAgainstFilter(mission, orFilter);
                          if(filterPassed) break;
                        }
                      }
                    }
                    if(!filterPassed) allFiltersPassed = false;
                  }
                }
                index++;
              }
              return allFiltersPassed;
            }

            const applyFilter = async () => {
              //Start a timer to see how long it takes to apply the filter
              const startTime = performance.now();

              dataBeingFiltered.value = true;
              filterHasChanged.value = false;
              const newFilteredMissions = [];
              for(const loadedMission of allLoadedMissions.value){
                if(await missionMatchesFilter(loadedMission, dataFilter.value, orDataFilter.value)){
                  newFilteredMissions.push(loadedMission);
                }
              }

              //Stop the timer and calculate the time it took to apply the filter
              const endTime = performance.now();
              const applyTime = endTime - startTime;

              //Display the time it took to apply the filter in seconds and ms
              const seconds = Math.floor(applyTime / 1000);
              const ms = Math.floor(applyTime % 1000);
              filterApplyTime.value = seconds + "." + ms + "s";
              window.filterApplyTime = filterApplyTime.value;

              filteredMissions.value = newFilteredMissions;
              dataBeingFiltered.value = false;
            };

            const targetImage = (target) => {
              if(target == null || target == "" || target == "UNKNOWN") return "";
              else{
                target = target.toUpperCase().replaceAll("ORNATE_GUSSET", "GUSSET").replaceAll("VIAL_MARTIAN_DUST", "VIAL_OF_MARTIAN_DUST");; //Redundancy
                var tier = 4;
                if(target.indexOf('_FRAGMENT') > -1) {
                  target = target.replace('_FRAGMENT', '');
                  tier = 1;
                }
                if(target == 'GOLD_METEORITE' || target == 'TAU_CETI_GEODE' || target == 'SOLAR_TITANIUM') tier = 3;
                const path = "images/artifacts/" + target + "/" + target + "_" + tier + ".png";
                return `<img src="` + path + `" alt="` + target + `"ml-1rem class="inline h-6 w-6 p-0.5 relative -top-px">`;
              }
            };

            //Set it up so that if a click is performed outside of the 'viewMissionDiv', closeOverlay() is called
            Vue.onMounted(() => {
              const largerDiv = document.getElementById('missionViewDiv');
              largerDiv.addEventListener('click', function(event) {
                if(this.style.display == 'none') return false; //If the overlay is already hidden, don't do anything
                const innerDiv = document.getElementById('innerMissionViewDiv');
                const divRect = innerDiv.getBoundingClientRect();
                const clickX = event.clientX;
                const clickY = event.clientY;
                if(clickX < divRect.left || clickX > divRect.right || clickY < divRect.top || clickY > divRect.bottom) closeOverlay();
              });
            });

            const padNumber = (num) => {
              num = parseInt(num.toString()); //Make sure it's a number
              return (num < 10 ? '0' : '') + num;
            }

            const viewSpecificMission = async (missionId) => {
              //Do not allow viewing a mission while data is being fetched - prevent collisions
              if(isFetching.value) return false; 

              const shipInfoStr = await window.getShipInfo(loadedEid.value, missionId);
              if(shipInfoStr == "") return;
              const shipInfo = JSON.parse(shipInfoStr);

              const loadValue = await window.getShipDrops(loadedEid.value, missionId);
              if(loadValue == "") return;
              const allDrops = JSON.parse(loadValue);

              const artifacts = allDrops.filter(drop => drop.specType == "Artifact");
              const stones = allDrops.filter(drop => drop.specType == "Stone");
              const stoneFragments = allDrops.filter(drop => drop.specType == "StoneFragment");
              const ingredients = allDrops.filter(drop => drop.specType == "Ingredient");
              //Compute the duration in days, hours, minutes

              const launchDateTime = new Date(
                shipInfo.launchYear, shipInfo.launchMonth, shipInfo.launchDay, 
                shipInfo.launchTime.split(':')[0], shipInfo.launchTime.split(':')[1], shipInfo.launchTime.split(':')[2]
              );
              const returnDateTime = new Date(
                shipInfo.returnYear, shipInfo.returnMonth, shipInfo.returnDay, 
                shipInfo.returnTime.split(':')[0], shipInfo.returnTime.split(':')[1], shipInfo.returnTime.split(':')[2]
              );
              const duration = returnDateTime - launchDateTime;
              const days = Math.floor(duration / (1000 * 60 * 60 * 24));
              const hours = Math.floor((duration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
              const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
              const durationString = (days > 0 ? days + "d" : "") + (hours > 0 ? hours + "h": "") + minutes + "m";
              const launchStr = shipInfo.launchYear + '-' + padNumber(shipInfo.launchMonth) + '-' + padNumber(shipInfo.launchDay) + ' ' + shipInfo.launchTime;
              const returnStr = shipInfo.returnYear + '-' + padNumber(shipInfo.returnMonth) + '-' + padNumber(shipInfo.returnDay) + ' ' + shipInfo.returnTime;

              //Find the loaded ships index in the allLoadedMissions array, to get the missions directly before and after it
              const shipIndex = allLoadedMissions.value.findIndex(mission => mission.missionId == missionId);
              const prevMission = shipIndex > 0 ? allLoadedMissions.value[shipIndex - 1].missionId : null;
              const nextMission = shipIndex < allLoadedMissions.value.length - 1 ? allLoadedMissions.value[shipIndex + 1].missionId : null;

              const newMissionViewData = {
                shipInfo: shipInfo,
                artifacts: sortedGroupedSpecType(artifacts),
                stones: sortedGroupedSpecType(stones),
                stoneFragments: sortedGroupedSpecType(stoneFragments),
                ingredients: sortedGroupedSpecType(ingredients),
                artifactCount: artifacts.length,
                stoneCount: stones.length,
                stoneFragmentCount: stoneFragments.length,
                ingredientCount: ingredients.length,
                launchStr: launchStr,
                returnStr: returnStr,
                durationStr: durationString,
                prevMission: prevMission,
                nextMission: nextMission
              };

              viewMissionData.value = newMissionViewData;
              openOverlay();
            };

            return {
              appVersion,
              appDirectory,
              appIsInForbiddenDirectory,
              appIsTranslocated,

              UITab,
              AppState,

              activeTab,

              knownAccounts,
              playerId,
              nicknameForSelectedPlayerId,
              playerIdSelectRef,
              playerIdInputRef,
              playerIdSubmitRef,
              playerIdDropdownOpen,
              openPlayerIdDropdown,
              closePlayerIdDropdown,
              selectPlayerId,
              fetchPlayerData,
              stopFetchingPlayerData,

              currentState,
              idle,
              missionProgress,
              exportedFiles,

              messagesRef,
              messages,
              hhmmss,

              appHasUpdate,

              //Daveed additions :^)
              doesExportExist,
              existingExports,
              readableExistingExports,
              selectedAccount,
              eidBeingLoaded,
              viewEidGo,
              toggleDay,
              toggleMonth,
              toggleYear,
              toggleAll,
              durToSpan,
              levelToStars,
              shipToName,
              viewSpecificMission,
              targetImage,
              closeOverlay,
              refreshExistingExports,
              viewByDate,
              loadedAccountMissionsCount,
              loadedEid,
              allLoadedMissions,
              filteredMissions,
              groupedMissions,
              possibleTargets,
              maxQuality,
              durationConfigs,
              artifactConfigs,
              boundEffectString,
              afRarityClass,
              afRarityText,
              afBackgroundClass,
              afExplorerName,
              specPath,
              groupedSpecType,
              numToDigClass,
              properCase,
              durToTextClass,
              viewMissionData,

              dataFilter,
              filterHasChanged,
              dataBeingFiltered,
              applyFilter,
              getTopLevelFilterOptions,
              getFilterOpOptions,
              getFilterValueOptions,
              topLevelFilterOptions,
              filterOperators,
              filterValues,
              hideFilter,
              removeAndShift,
              removeOrAndShift,
              addOr,
              filterApplyTime,
              orFilterConditionsCount,
              orFilterTopLevelOptions,
              orFilterOperators,
              orFilterValues,
              generateFilterConditionsArr,
              generateOrFiltersConditionsArr,

              updateFilterConditionsCount: window.updateFilterConditionsCount,
              openFile: window.openFile,
              openFileInFolder: window.openFileInFolder,
              openURL: window.openURL,
            };
          },
        });

        app.directive('unhide', {
          mounted(el) {
            el.style.display = '';
          },
        });

        // <a v-external-link> opens the link in the default browser rather than the in-app browser.
        app.directive('external-link', {
          mounted(el) {
            el.addEventListener('click', event => {
              event.preventDefault();
              window.openURL(el.href);
            });
          },
        });

        app.mount('#app');
      })();
    </script>
  </body>
</html>
