<!DOCTYPE html>
<html lang="en" class="bg-darker">
  <head>
    <title>EggLedger</title>
    <link rel="icon" href="images/icon-64.png" />
    <link rel="stylesheet" href="index.css" />
    <link rel="stylesheet" href="custom.css" />
    <script src="vue.global.prod.js"></script>
    <script src="shortcuts.js"></script>
  </head>
  <body>
    <div id="app" class="h-stretch">
      <!-- Set display to none initially and reset it once mounted to avoid flash of unrendered template. -->
      <div v-unhide class="h-stretch flex flex-col space-y-3 pb-3 bg-darker" style="display: none">
        <div class="h-11 flex-shrink-0 bg-dark">
          <div class="h-full flex items-end w-full mx-auto px-4 space-x-1.5 bg-dark border-b border-gray-300">
            <div
              v-for="tab in [UITab.Ledger, UITab.ViewData, UITab.LifetimeDrops, UITab.About, UITab.Donate]"
              class="relative -bottom-px px-4 pt-1.5 pb-1 text-sm font-medium text-gray-400 border border-darker_tab border-300 rounded-t-md"
              v-bind:class="tab === activeTab ? 'bg-dark_tab border-b-transparent' : 'bg-darker_tab hover:bg-dark_tab_hover cursor-pointer'"
              v-on:click="activeTab = tab" v-bind:key="tab">
              {{ tab }}
            </div>
          </div>
        </div>

        <div
          v-if="appIsInForbiddenDirectory || appIsTranslocated"
          v-show="activeTab === UITab.Ledger"
          class="flex-1 flex flex-col w-full mx-auto px-4 space-y-3 overflow-y-scroll bg-darker">
          <div class="text-sm text-gray-400 space-y-1">
            <template v-if="appIsTranslocated">
              <p class="text-red-700">
                EggLedger.app was launched in a jailed environment due to a macOS security feature.
                The app cannot write data to disk in this environment. To work around this, run the
                <span class="text-indigo-700">preflight</span> script which came with the app, then
                restart the app. See <span class="text-indigo-700">README.html</span> (also came
                with the app) for details.
              </p>
            </template>

            <template v-else>
              <p class="text-red-700">
                You app is located in <span class="text-indigo-700">{{ appDirectory }}</span>. The
                app stores all its data relative to itself, which would pollute this shared folder.
                Please close this window, create a separate folder for EggLedger, move the app into
                it, and try again.
              </p>
              <p>See "Where does EggLedger store data?" in the About tab for more details.</p>
            </template>
          </div>
        </div>

        <div
          v-else
          v-show="activeTab === UITab.Ledger"
          class="flex-1 flex flex-col w-full mx-auto px-4 space-y-3 overflow-hidden bg-darker">
          <div>
            <form
              id="ledgerForm" name="ledgerForm" class="select-form"
              v-on:submit="event => {
                event.preventDefault();
                closePlayerIdDropdown();
                fetchPlayerData();
              }"
            >
              <div ref="playerIdSelectRef" class="tooltip-custom relative flex-grow focus-within:z-10">
                <!-- Overlay to tag the input with the corresponding nickname (if the playerId in the input is known). -->
                <div v-if="nicknameForSelectedPlayerId" class="ledger-input-overlay">
                  <span class="invisible whitespace-pre">
                    {{ playerId }}</span> (<span :style="'color: #' + objectedExistingData.find(acc => acc.id == playerId)?.accountColor">{{
                    nicknameForSelectedPlayerId }} {{ objectedExistingData.find(acc => acc.id == playerId)?.ebString ?? "???" }}
                  </span>) 
                </div>
                <div v-if="!isPlayerIdValid" class="ledger-input-overlay">
                  <span class="invisible whitespace-pre">
                    {{ playerId }}</span> ( <span class="text-red-700">Invalid EID: {{getEidProblem(playerId)}}</span> )
                  </span>
                </div>
                <input
                  ref="playerIdInputRef"
                  id="playerIdInput"
                  type="text"
                  :class="'drop-select ' + (isPlayerIdValid ? 'border-gray-300' : 'border-red-700')"
                  placeholder="EI1234567890123456"
                  v-bind:value="playerId"
                  v-on:focus="openPlayerIdDropdown"
                  v-on:input="playerId = $event.target.value"
                />

                <ul
                  v-if="playerIdDropdownOpen && knownAccounts.length > 0"
                  class="ledger-list focus:outline-none sm:text-sm"
                  tabindex="-1"
                >
                  <li
                    v-for="account in knownAccounts"
                    v-bind:key="account.id" class="drop-opt"
                    v-on:click="selectPlayerId(account.id)"
                  >
                    {{ account.id }} (<span :style="'color: #' + objectedExistingData.find(acc => acc.id == account.id)?.accountColor">{{
                      objectedExistingData.find(acc => acc.id == account.id)?.nickname }} {{ objectedExistingData.find(acc => acc.id == account.id)?.ebString ?? "???" }}</span>) 
                  </li>
                </ul>
              </div>
              <button
                v-if="idle" ref="playerIdSubmitRef" type="submit" class="fetch-button disabled:hover:darker_tab_hover"
                v-bind:disabled="playerId.trim() === '' || !isPlayerIdValid"
              >
                Fetch
              </button>
              <button
                v-else ref="stopFetchSubmitRef" type="button" class="fetch-button disabled:hover:darker_tab_hover"
                v-on:click="stopFetchingPlayerData(); refreshExistingData();"
              >
                Stop
              </button>
            </form>
          </div>

          <div class="h-14 px-2 py-1 text-xs text-gray-500 bg-darkest rounded-md tabular-nums">
            <template v-if="currentState === AppState.FetchingSave">Fetching save...</template>
            <template v-else-if="currentState === AppState.FetchingMissions">
              <div>
                Fetching missions...<br />
                {{ missionProgress.finished }}/{{ missionProgress.total }}, ETA {{
                missionProgress.eta }}
              </div>
              <div class="h-3 relative rounded-full overflow-hidden mt-1">
                <div class="w-full h-full bg-gray-200 absolute"></div>
                <div class="h-full absolute rounded-full bg-green-500"
                  v-bind:style="{ width: missionProgress.finishedPercentage }"
                ></div>
              </div>
            </template>
            <template v-else-if="currentState === AppState.ExportingData"
              >Exporting data...</template
            >
            <template v-else-if="currentState === AppState.Success">
              Successfully exported to:
              <div class="grid gap-x-2" style="grid-template-columns: repeat(2, max-content)">
                <template v-for="file in exportedFiles" v-bind:key="file">
                  <button class="file-link" v-on:click="openFile(file)">{{ file }}</button>
                  <button class="url-link truncate" v-on:click="openFileInFolder(file)">open in folder</button>
                </template>
              </div>
            </template>
            <template v-else-if="currentState === AppState.Failed">
              Data fetching failed. Please try again.<br />
            </template>
            <template v-else-if="currentState === AppState.Interrupted">Interrupted.</template>
          </div>

          <div ref="messagesRef" class="flex-1 px-2 py-1 overflow-auto shadow-sm block text-xs font-mono text-gray-400 bg-darkest rounded-md">
            <div v-for="(message, i) in messages" :key="i" class="whitespace-pre">
              <span v-bind:class="message.isError ? 'text-red-700' : 'text-green-700'">{{ hhmmss(message.timestamp) }}|</span>
              <template v-if="message.isError" v-for="segment in extractColorSegments(message.content)">
              <span v-if="segment?.color" :style="'color: #' + segment?.color">{{ segment.text }}</span>
              <span class="text-red-700" v-else>{{ segment.text }}</span>
            </template>
            <template v-else v-for="segment in extractColorSegments(message.content)">
              <span v-if="segment?.color" :style="'color: #' + segment?.color">{{ segment.text }}</span>
              <span v-else>{{ segment.text }}</span>
            </template>
            </div>
          </div>
        </div>

        <div v-show="activeTab === UITab.About" class="flex-1 w-full mx-auto px-4 overflow-y-auto">
          <div class="text-sm text-gray-400 space-y-2">
            <p class="space-x-3">
              <a
                v-external-link
                href="https://github.com/DavidArthurCole/EggLedger/releases"
                target="_blank"
                class="file-link"
                >Check for updates</a
              >
              <a
                v-external-link
                href="https://wasmegg-carpet.netlify.app/"
                target="_blank"
                class="file-link"
                >More tools</a
              >
            </p>

            <hr />
            <div class="space-y-1">
              <h2 class="font-bold">Is mk2 back?</h2>
              <p>
                No. This tool is now being developed independently of mk2 - the community has taken over his orphaned tools since he went AWOL in 2022.
              </p> 
              <p>
                <i>For EggLedger</i>, <i>specifically</i>, I (<a
                  v-external-link
                  href="https://github.com/DavidArthurCole"
                  target="_blank"
                  class="url-link"
                  >DavidArthurCole</a
                >) am the active developer and maintainer.
              </p> 
              <p>
                To report issues, ask for changes, and more generally, to reach me with any information, reach out on discord <span class="text-short">@davidarthurcole</span>, or <a 
                  v-external-link
                  href="https://github.com/DavidArthurCole/EggLedger/issues/new/choose"
                  target="_blank"
                  class="url-link"
                >open an Issue on GitHub</a>.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">What does EggLedger do?</h2>
              <p>
                EggLedger helps export your spaceship mission data, including loot from each
                mission, to .xlsx (Excel) and .csv formats for further analysis.
              </p>
              <p>   
                It is an extension to the
                <a
                  v-external-link
                  href="https://wasmegg-carpet.netlify.app/rockets-tracker/"
                  target="_blank"
                  class="url-link"
                  >rockets tracker</a
                >, answering questions like "from which mission did I obtain this legendary
                artifact?" and "how many of this item dropped from my ships?" which can't be
                answered there due to technical or UI limitations.
              </p>
              <p>
                In addition, it mimics the functionality of rockets tracker to provide you access
                to view your mission data in a more user-friendly way, and lets you filter missions
                by various criteria.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">How do I use EggLedger?</h2>
              <p>
                <ul class="about-list-1">
                  <li>Go to the Ledger tab</li>
                  <li>Enter your Egg, Inc. account ID</li>
                  <li>
                    Press "Fetch"
                    <ul class="about-list-2">
                      <li>The first fetch session for an account could take a while, if you have lots of completed missions</li>
                      <li>Subsequent sessions will only fetch unrecorded missions</li>
                    </ul>
                  </li>
                </ul>
                <span class="ledger-underline">Data for multiple accounts can coexist.</span>
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">When I use EggLedger, are my data shared with anyone?</h2>
              <p>
                No. EggLedger communicates with the Egg, Inc. API directly, meaning all your data is
                kept 100% private. No data or analytics is collected by the EggLedger developer.
              </p>
              <p>
                The only third party request is the occasional update check against github.com; this is
                the biggest open source code hosting service, there is no personal data attached to
                the requests and no logs are available to me.
              </p>
              <p> 
                Unless you tell me over another channel, there's no way I can determine if you're even using this tool, let alone
                acquiring collecting any info about your account.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Are there risks to my account if I use EggLedger?</h2>
              <p>
                I'm not aware of any negative effects, and
                <a
                  v-external-link
                  href="https://wasmegg-carpet.netlify.app/rockets-tracker/"
                  target="_blank"
                  class="url-link"
                  >rockets tracker</a
                > has been safely operating with the same techniques for a very long time.
              </p>
              <p>
                Do realize that no community-made tools are sanctioned by the Egg, Inc. developer, so you use them at
                your own risk. I'm not responsible for any negative effects.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Where do I find my Egg, Inc. account ID?</h2>
              <p>
                <ul class="about-list-1">
                  <li class="mt-1">
                    Open the game menu <img src="images/icon_menu.webp" alt="Menu Icon" class="game-btn-ico"/>
                  </li>
                  <li class="mt-1">
                    Choose Settings <img src="images/icon_settings.webp" alt="Settings Icon" class="game-btn-ico"/>
                  </li>
                  <li class="mt-1 mb-1">
                    Choose &nbsp; <span class="p-0.5 text-xs rounded-md bg-privacy_blue w-4 pl-3 pr-3"> Privacy &amp; Data </span>
                  </li>
                  <li class="mt1">
                    Your EID is at the bottom
                    <ul class="about-list-2">
                      <li class="mt-1">
                        <span class="ledger-underline">It should look like EI1234567890123456</span>. That's the
                        letters "EI" followed by 16 digits.
                      </li>
                      <li class="mt-1 mb-1">
                        Alternatively, if you choose Help
                        <img
                          src="images/icon_help.webp"
                          alt="Help Icon"
                          class="game-btn-ico"
                        />
                        in the main menu and click on &nbsp; <span class="p-0.5 text-xs rounded-md bg-data_loss_red w-4 pl-3 pr-3"> Data Loss Issue </span> &nbsp; the game will auto-compose an email
                        with your ID in the subject
                      </li>
                    </ul>
                  </li>
                </ul>
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Why are my latest missions missing?</h2>
              <p>
                The server backup is probably out of date. Pay attention to the message printed
                about the freshness of your backup whenever your backup is fetched.
              </p>
              <p>
                The game, while active, backs up your game state to Egg, Inc.'s server every couple
                of minutes if network condition allows, but these are mostly unpredictable.
                <span class="ledger-underline"
                  >Force closing and reopening the game, or switching to another farm, can fairly
                  reliably trigger a new backup.</span
                >
              </p>
              <p>
                However, even after an app-initiated backup, it may take an unpredictable amount of
                time (usually no longer than a minute or two) for the game server to serve the
                updated backup through its API. EggLedger won't see the missions until then.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Where does EggLedger store data?</h2>
              <p>
                All configurations, data, and exported files are stored in the same directory as the EggLedger application.
              </p>
              <p>
                <span class="ledger-underline">Make sure you put EggLedger in a directory of its own, and don't touch the "internal" directory</span> (or you risk data corruption).
              </p>
              <p>
                If you want to uninstall EggLedger, just delete the directory, and it won't leave any trace on your system.
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Where do I get @mk2's autograph?</h2>
              <p>
                <a
                  v-external-link
                  href="https://areyousure.netlify.app/"
                  target="_blank"
                  class="url-link"
                  >Are you sure</a
                >
                you want @mk2's autograph?
              </p>
            </div>
            <hr />

            <div class="space-y-1">
              <h2 class="font-bold">Known issues</h2>
              <ul class="about-list-1">
                <li>On macOS, clicking on the app in dock can open a new browser window</li>
                <li>On Windows, resolution of the task bar app icon is garbage</li>
                <li>
                  Some ships may fail to pull during a fetch
                  <ul class="about-list-2">
                    <li>An ocassional API timeout is normal, and another fetch should work to pull these missions</li>
                    <li>If frequent timeouts occur, or the same ship fails to pull repeatedly, please reach out</li>
                  </ul>
                </li>
                <li>
                  Due to the immense number of elements generated, the "View Mission Data" tab may be slow to load
                </li>
              </ul>
            </div>
            <hr />
          </div>
        </div>

        <div v-show="activeTab === UITab.Donate" class="flex-1 w-full mx-auto px-4 overflow-y-auto text-center items-center">
          <div
            class="border border-gray-300 rounded-md p-0.5"
          >
            <span class="text-gray-400 space-y-2">
              <span class="text-lg ledger-underline mb-1rem">Hello</span><br />
              Although I thoroughly enjoy developing this tool, it does take<br />
              a lot of time and effort. If you find this tool, or any other tools<br />
              I develop/support useful, please consider <a
                v-external-link
                href="https://www.buymeacoffee.com/davidarthurcole"
                target="_blank"
                class="file-link"
                >buying me a coffee</a
              >.<br />
              to support continued development. Thank you. 🫶
            </span><br />
            <img 
              src="images/coffee.gif"
              alt="Coffee"
              class="mx-auto bg-transparent max-w-80"
            />
          </div>
        </div>

        <div v-show="activeTab === UITab.ViewData" class="flex-1 flex flex-col w-full mx-auto px-4 space-y-3 overflow-hidden bg-darker" >
          <div id="dropSelectDiv" ref="dropSelectDiv" class="popup-selector-main overlay-drop">
            <div id="innerDropSelectDiv"  class="popup-selector-inner">
              <button class="close-button" v-on:click="closeDropFilterMenu()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
              <input
                id="drop-search"
                type="text"
                class="input-search"
                placeholder="Search..."
                v-bind:value="dropSearchTerm"
                v-on:focus="e => {e.preventDefault(); e.stopPropagation(); }"
                v-on:input="dropSearchTerm = $event.target.value"
              />
              <div id="dropSelectContentDiv" class="popup-opt-container">
                <div v-for="drop in dropSelectList" v-bind:key="drop" class="popup-opt" v-on:click="e => {e.preventDefault(); selectDropFilter(drop); }">
                  <img class="mr-1rem max-w-7" v-if="drop.imagePath != null && drop.imagePath != ''" :alt="drop.text" :src="`images/${drop.imagePath}`" 
                    :style="(drop.rarityGif ? 'background: url(' + drop.rarityGif + ') center center no-repeat; background-size: cover;' : '')"
                  />
                  <span :class="(drop.styleClass ?? '')">
                    {{ drop.text }}
                  </span>
                </div>
                <div v-if="dropSelectList == [] || dropSelectList.length == 0">
                  <span class="text-gray-400">
                    No results found.
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div id="targetSelectDiv" ref="targetSelectDiv" class="popup-selector-main overlay-target">
            <div id="innerTargetSelectDiv" class="popup-selector-inner">
              <button class="close-button" v-on:click="closeTargetFilterMenu()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
              <input
                id="target-search"
                type="text"
                class="input-search" 
                placeholder="Search..."
                v-bind:value="targetSearchTerm"
                v-on:focus="e => {e.preventDefault(); e.stopPropagation(); }"
                v-on:input="targetSearchTerm = $event.target.value"
              />
              <div id="targetSelectContentDiv" class="popup-opt-container">
                <div v-for="target in targetSelectList" v-bind:key="target" class="popup-opt" v-on:click="e => {e.preventDefault(); selectTargetFilter(target); }">
                  <img class="mr-1rem max-w-7" v-if="target.imagePath != null && target.imagePath != ''" :alt="target.text" :src="`images/targets/${target.imagePath}`"/>
                  <span class="text-gray-400">
                    {{ target.text }}
                  </span>
                </div>
                <div v-if="targetSelectList == [] || targetSelectList.length == 0">
                  <span class="text-gray-400">
                    No results found.
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div id="missionViewDiv" ref="missionViewDiv" class="w-full h-full z-40 fixed top-0 left-0 right-0 bottom-0 hidden items-center justify-center overlay-mission">
            <div id="innerMissionViewDiv" style="max-height: 80vw;"  class="bg-dark rounded-lg relative p-1rem">
              <button class="close-button" v-on:click="closeMissionOverlay()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
              <div id="missionViewContentDiv" v-if="(viewMissionData && viewMissionData != {} && viewMissionData.shipInfo != null)" 
                style="max-height: 70vh; max-width: 35vw; min-width: 30vw;" class="text-gray-300 text-center overflow-auto">
                <!-- Header information about the mission -->
                <span :class="durToTextClass(viewMissionData.shipInfo.durationType)">{{ shipToName(viewMissionData.shipInfo.ship) }}</span><br />
                <span class="text-star text-goldenstar" v-if="viewMissionData.shipInfo.level && viewMissionData.shipInfo.level > 0">{{ "★".repeat(viewMissionData.shipInfo.level) }}</span>
                <br v-if="viewMissionData.shipInfo.level && viewMissionData.shipInfo.level > 0" />
                <span>Launched: {{ viewMissionData.launchStr }}</span> <br />
                <span>Returned: {{ viewMissionData.returnStr }}</span> <br />
                <span>Duration: {{ viewMissionData.durationStr }}</span> <br />
                <span class="flex flex-row items-center justify-center">
                  <span :class="(viewMissionData.shipInfo.isDubCap ? 'mr-05rem' : '')">Capacity: {{ viewMissionData.shipInfo.capacity }} </span>
                  <span v-if="viewMissionData.shipInfo.isDubCap" 
                    class="max-w-28 flex py-1 double-cap-span items-center justify-center flex-1">
                    <img alt="Artifact Crate" src="https://eggincassets.tcl.sh/64/egginc/icon_afx_chest_2.png" class="w-6 mr-05rem">
                    <span class="tooltip-custom text-xs font-bold"> {{viewMissionData.capacityModifier}}x Capacity
                        <span class="font-normal text-sm text-gray-400 tooltiptext-custom speech-bubble">This ship was launched during a<br />
                          <span class="text-dubcap">
                            {{viewMissionData.capacityModifier}}x Capacity Event
                          </span>
                          and returned with<br />
                          more artifacts than normal.
                        </span>
                      </span>
                    </span>
                    <br />
                  </span>
                <div v-if="viewMissionData.shipInfo.target != '' && viewMissionData.shipInfo.target.toUpperCase() != 'UNKNOWN'">
                  <div class="items-center justify-center flex">
                    <span>Sensor Target: </span>
                    <div class="ml-1 text-center text-xs rounded-full w-max px-1.5 py-0.5 text-gray-400 bg-darkerer font-semibold">
                      {{ properCase(viewMissionData.shipInfo.target.replaceAll("_", " ")) }}
                    </div>
                  </div>
                  <br/>
                </div>
                <!-- Previous mission -->
                <button v-bind:disabled="viewMissionData.prevMission == null" v-on:click="viewSpecificMission(viewMissionData.prevMission)" title="Previous mission"
                class="disabled:hover:cursor-not-allowed absolute left-0 top-1/2 transform -translate-y-1/2 pl-2 rounded-md text-gray-400 focus:outline-none z-10 disabled:text-gray-500 hover:text-gray-500">
                  <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <!-- Next mission -->
                <button v-bind:disabled="viewMissionData.nextMission == null" v-on:click="viewSpecificMission(viewMissionData.nextMission)" title="Next mission"
                class="disabled:hover:cursor-not-allowed absolute right-0 top-1/2 transform -translate-y-1/2 pr-2 rounded-md text-gray-400 focus:outline-none z-10 disabled:text-gray-500 hover:text-gray-500">
                  <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>

                <!-- Artifacts -->
                <div v-if="viewMissionData.artifactCount > 0">
                  <div class="mission-view-div bg-blue-900">
                    Artifacts ({{ viewMissionData.artifactCount }})
                  </div>
                  <div class="ledger-af-repeat">
                    <div class="mission-view-rep" v-for="(af, afindex) in viewMissionData.artifacts">
                      <a v-external-link :class="'ledger-af-link tooltip-custom ' + afBackgroundClass(af)" 
                        target="_blank" :href="'https://wasmegg-carpet.netlify.app/artifact-explorer/#/artifact/' + afExplorerName(af, 1) + '/'">
                        <img class="h-full w-full" :alt="af.gameName" :src="specPath(af, 1)"/>
                        <div v-if="af.count > 1" :class="'ledger-af-count ' + numToDigClass(af.count)">
                          {{ af.count }}
                        </div>
                        <span class="text-sm tooltiptext-custom speech-bubble">
                          {{ af.gameName }} (T{{parseInt(af.level) + 1}})
                          <span :class="afRarityClass(af)">
                            {{ afRarityText(af) }}
                          </span>
                          × {{ af.count }} <br />
                          {{ boundEffectString(af.effectString)[0] }}
                          <span class="text-sm text-green-500">
                            {{ boundEffectString(af.effectString)[1] }}
                          </span>
                          {{ boundEffectString(af.effectString)[2] }}
                        </span>
                      </a>
                    </div>
                  </div>
                  <br />
                </div>

                <!-- Stones -->
                <div v-if="viewMissionData.stoneCount > 0">
                  <div class="mission-view-div bg-fuchsia-900">
                    Eggfinity Stones ({{ viewMissionData.stoneCount }})
                  </div>
                  <div class="ledger-af-repeat">
                    <div class="mission-view-rep" v-for="(st, stindex) in viewMissionData.stones">
                      <a v-external-link class="ledger-af-link tooltip-custom bg-common" 
                        target="_blank" :href="'https://wasmegg-carpet.netlify.app/artifact-explorer/#/artifact/' + afExplorerName(st, 2) + '/'">
                        <img class="h-full w-full" :alt="st.gameName" :src="specPath(st, 2)"/>
                        <div v-if="st.count > 1" :class="'ledger-af-count ' + numToDigClass(st.count)">
                          {{ st.count }}
                        </div>
                        <span class="text-sm tooltiptext-custom speech-bubble">
                          {{ st.gameName }} (T{{parseInt(st.level) + 2}})
                          × {{ st.count }} <br />
                          {{ boundEffectString(st.effectString)[0] }}
                          <span class="text-sm text-green-500">
                            {{ boundEffectString(st.effectString)[1] }}
                          </span>
                          {{ boundEffectString(st.effectString)[2] }}
                        </span>
                      </a>
                    </div>
                  </div>
                  <br />
                </div>

                <!-- Ingredients -->
                <div v-if="viewMissionData.ingredientCount > 0">
                  <div class="mission-view-div text-gray-400 bg-darkerer">
                    Ingredients ({{ viewMissionData.ingredientCount }})
                  </div>
                  <div class="ledger-af-repeat">
                    <div class="mission-view-rep" v-for="(ing, ingindex) in viewMissionData.ingredients">
                      <a v-external-link class="ledger-af-link tooltip-custom bg-common" 
                        target="_blank" :href="'https://wasmegg-carpet.netlify.app/artifact-explorer/#/artifact/' + afExplorerName(ing, 1) + '/'">
                        <img class="h-full w-full" :alt="ing.gameName" :src="specPath(ing, 1)"/>
                        <div v-if="ing.count > 1" :class="'ledger-af-count ' + numToDigClass(ing.count)">
                          {{ ing.count }}
                        </div>
                        <span class="text-sm tooltiptext-custom speech-bubble">
                          {{ ing.gameName }} (T{{parseInt(ing.level) + 1}})
                          × {{ ing.count }}
                        </span>
                      </a>
                    </div>
                  </div>
                  <br />
                </div>

                <!-- Stone Fragments -->
                <div v-if="viewMissionData.stoneFragmentCount > 0">
                  <div class="mission-view-div text-gray-400 bg-darkerer">
                    Stone Fragments ({{ viewMissionData.stoneFragmentCount }})
                  </div>
                  <div class="ledger-af-repeat">
                    <div class="mission-view-rep" v-for="(sf, sfindex) in viewMissionData.stoneFragments">
                      <a v-external-link class="ledger-af-link tooltip-custom bg-darker" 
                        target="_blank" :href="'https://wasmegg-carpet.netlify.app/artifact-explorer/#/artifact/' + afExplorerName(sf, 1) + '/'">
                        <img class="h-full w-full" :alt="sf.gameName" :src="specPath(sf, 1)"/>
                        <div v-if="sf.count > 1" :class="'ledger-af-count ' + numToDigClass(sf.count)">
                          {{ sf.count }}
                        </div>
                        <span class="text-sm tooltiptext-custom speech-bubble">
                          {{ sf.gameName }} (T{{parseInt(sf.level) + 1}})
                          × {{ sf.count }} <br />
                      </a>
                    </div>
                    <br />
                  </div>
                </div>

                <!-- Shamelessly stolen straight from MK2's source code, with mobile note removed -->
                <div class="mt-2 text-xs text-gray-300 text-center">
                  Hover mouse over an item to show details.<br />
                  Click to open the relevant <a target="_blank" v-external-link href="https://wasmegg-carpet.netlify.app/artifact-explorer/" class="ledger-underline">
                    artifact explorer
                  </a> page.
                </div>

                <!-- End mission view-->
              </div>
            </div>
          </div>
          <div class="mt-0i" ref="selectViewMissionsAccountForm" v-if="doesDataExist">
            <form 
              id="viewAccountForm" name="viewAccountForm" class="select-form"
              v-on:submit="event => {
                event.preventDefault();
                for(let i = 0; i < topLevelFilterOptions.length; i++) removeAndShift(i);
                viewMissionsOfEid();
              }">
              <div ref="viewMissionAccountSelectRef" class="relative flex-grow focus-within:z-10">
                <!-- Overlay to tag inmput with number of missions -->
                <div v-if="selectedMissionAccount != null && objectedExistingData.find(acc => acc.id == selectedMissionAccount) != null" class="ledger-input-overlay">
                  <span class="invisible whitespace-pre">
                    {{ objectedExistingData.find(acc => acc.id == selectedMissionAccount)?.id }}
                  </span> (<span :style="'color: #' + objectedExistingData.find(acc => acc.id == selectedMissionAccount)?.accountColor" >
                      {{ objectedExistingData.find(acc => acc.id == selectedMissionAccount)?.nickname }} {{ objectedExistingData.find(acc => acc.id == selectedMissionAccount)?.ebString }}
                    </span> - {{ objectedExistingData.find(acc => acc.id == selectedMissionAccount)?.missionCount }} missions)
                </div>

                <input
                  ref="viewMissionAccountInputRef"
                  type="text"
                  class="drop-select border-gray-300"
                  placeholder="Select an account"
                  v-bind:value="selectedMissionAccount"
                  v-on:focus="openMissionsViewAccountDropdown"
                  v-on:input="selectedMissionAccount = $event.target.value"
                >
                <ul
                  v-if="viewMissionAccountDropdownOpen && objectedExistingData.length > 0"
                  class="ledger-list focus:outline-none sm:text-sm"
                  tabindex="-1"
                >
                  <li
                    v-for="account in objectedExistingData"
                    v-bind:key="account.id" class="drop-opt"
                    v-on:click="selectViewAccount(account)"
                  >
                    {{account.id}} (<span :style="'color: #' + account.accountColor">{{ account.nickname }} {{ account.ebString }}</span> - {{ account.missionCount }} missions)
                  </li>
                </ul>
              </div>
              <button class="-ml-px relative w-20 text-center space-x-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-r-md text-gray-400 filter-button"
              v-if="idle" ref="viewMissionAccountSubmitRef" type="submit" v-bind:disabled="(selectedMissionAccount === null || selectedMissionAccount == '' || objectedExistingData.find(a => a.id == selectedMissionAccount) == null || eidMissionsBeingLoaded)">
                View
              </button>
            </form>
          </div>
          <div class="text-center mt-3rem rounded-md border border-red-700 py-2" ref="noDataToView" v-else>
            <span class="text-red-700"> No mission data has been loaded yet.<br>Please <b>Fetch</b> from the </span><button type="button" class="btn-link" v-on:click="activeTab = UITab.Ledger" ><span class="text-blue-500 ledger-underline font-bold">Ledger tab</span></button><span class="text-red-700"> and then come back here.</span>
          </div>
          <div v-if="groupedMissions && Object.keys(groupedMissions).length > 0 || (filteredMissions != null && allLoadedMissions != null && Object.keys(filteredMissions).length != Object.keys(allLoadedMissions).length)">
            <div class="mt-1rem mb-1rem" v-if="selectedMissionAccount != null && selectedMissionAccount == loadedEid && loadedAccountMissionsCount != (objectedExistingData.find(acc => acc.id == selectedMissionAccount)?.missionCount ?? 0)">
              <span class="text-red-700 border border-red-700 rounded-md mb-1 py-2 px-4"> You are viewing outdated data - click <span class="text-gray-500">View</span> again to fix this.</span>
            </div>
            <div ref="filterRef">
              <span class="ml-05rem font-bold text-gray-400">Filter: </span>
              <button 
                id="toggleFilterButton"
                class="text-base toggle-link" 
                type="button" 
                v-on:click="e => {
                  e.preventDefault();
                  hideFilter = !hideFilter;
                  e.target.innerHTML = hideFilter ? 'Show' : 'Hide';
                }"
              >
                Hide
              </button>
              <form 
                id="filterForm"
                name="filterForm"
                v-if="!hideFilter"
                class="filter-form text-xs"
                v-on:submit="event => {
                  event.preventDefault();
                  applyFilter();
                }"
              >
                <!-- Warning (if not already seen) -->
                <div v-if="!(filterWarningRead) && !hideFilterWarning" class="text-red-700 border border-red-700 rounded-md mb-1 mt-1 py-2 px-4 max-w-500p">
                  <span class="font-bold ledger-underline mb-025rem">Warning:</span><br />
                  The filter feature is experimental, and may not work as expected (especially with complicated combinations). You may experience unexpected results, including lag spikes, potential app crashes, and UI distortion. Please use it carefully, and report any issues you encounter.
                  <br /><br />
                  <button type="button" class="p-075rem btn-link text-blue-500 border border-blue-500 rounded-md" v-on:click="dismissFilterWarning()">I understand</button>
                </div>
                <div class="max-h-60 overflow-y-auto">
                  <div class="relative flex-grow max-h-6/10" v-for="(item, index) in generateFilterConditionsArr()" :key="index">
                    <!-- Separator -->
                    <div v-if="index != 0" class="text-gray-400 mt-05rem">-- AND --</div>

                    <div class="filter-container focus-within:z-10">
                      <!-- Top level filter options -->
                      <select class="filter-select border-gray-300 text-gray-400"
                        v-on:change="handleFilterChange"
                        v-model="topLevelFilterOptions[index]" :id="'filter-top-' + index">
                        <option v-for="validOption in getTopLevelFilterOptions()" v-bind:key="validOption" v-bind:value="validOption.value">
                          {{ validOption.text }}
                      </select>

                      <!-- Operator options -->
                      <select class="filter-select border-gray-300 text-gray-400"
                        v-on:change="handleFilterChange"
                        v-if="topLevelFilterOptions[index] != null" v-model="filterOperators[index]" :id="'filter-op-' + index">
                        <option v-for="validOperator in getFilterOpOptions(topLevelFilterOptions[index])" v-bind:key="validOperator" v-bind:value="validOperator.value">
                          {{ validOperator.text }}
                      </select>

                      <!-- Value options (Base) -->
                      <select class="filter-select border-gray-300 text-gray-400"
                        v-on:change="handleFilterChange"
                        v-if="topLevelFilterOptions[index] != null && filterOperators[index] != null && isBaseFilter(topLevelFilterOptions[index])"
                        v-model="filterValues[index]" :id="'filter-value-' + index">
                        <option v-for="validValue in getFilterValueOptions(topLevelFilterOptions[index])" :class="validValue.styleClass ?? ''" v-bind:key="validValue" v-bind:value="validValue.value">
                          {{ validValue.text }}
                      </select>

                      <!-- Drop Selectors
                        opens a custom modal -->
                      <input type="text" v-on:click="e => {e.preventDefault(); openDropFilterMenu(index, null);}"
                        v-if="topLevelFilterOptions[index] != null && filterOperators[index] != null && topLevelFilterOptions[index] == 'drops'"
                        class="filter-select w-auto border-gray-300 text-gray-400" placeholder="Click to select" readonly
                        v-model="dFilterValues[index]" :id="'filter-value-' + index"
                      >

                      <!-- Target Selectors
                        opens a custom modal -->
                      <input type="text" v-on:click="e => {e.preventDefault(); openTargetFilterMenu(index, null);}"
                        v-if="topLevelFilterOptions[index] != null && filterOperators[index] != null && topLevelFilterOptions[index] == 'target'"
                        class="filter-select w-auto border-gray-300 text-gray-400" placeholder="Click to select" readonly
                        v-model="dFilterValues[index]" :id="'filter-value-' + index"
                      >

                      <!-- Value options - Launch/Return Date Selectors
                        Min: 20 January 2021  
                        Max: Today-->
                      <input type="date" min="2021-01-20" :max="new Date().toISOString().split('T')[0]" v-model="filterValues[index]"
                        class="filter-select border-gray-300 text-gray-400"
                        v-if="topLevelFilterOptions[index] != null && filterOperators[index] != null && (topLevelFilterOptions[index] == 'launchDT' || topLevelFilterOptions[index] == 'returnDT')"
                        v-on:change="handleFilterChange" required="required"
                        v-bind:disabled="topLevelFilterOptions[index + 1] != null" :id="'filter-value-' + index">

                      <!-- OR controls -->
                      <button type="button" v-on:click="e => {e.preventDefault(); addOr(index);}"
                        title="Add alternate filter condition"
                        class="mr-1rem flex items-center h-6 w-6 justify-center text-sml border text-yellow-700 border-yellow-700 bg-darkest rounded-md bg-transparent py-2 px-4 mt-05rem filter-button"
                        v-if="topLevelFilterOptions[index] != null && filterOperators[index] != null && filterValues[index] != null && ((topLevelFilterOptions[index] != 'returnDT' && topLevelFilterOptions[index] != 'launchDT') || filterValues[index] != '')"
                        v-bind:disabled="orFilterConditionsCount[index] != null && orFilterConditionsCount[index] != 0 && (orFilterTopLevelOptions[index][orFilterConditionsCount[index] - 1] == null || orFilterOperators [index][orFilterConditionsCount[index] - 1] == null || orFilterValues[index][orFilterConditionsCount[index] - 1] == null)">
                        OR
                      </button>

                      <!-- Clear button-->
                      <button 
                        v-if="topLevelFilterOptions[index] != null"
                        class="mr-1rem flex items-center justify-center text-red-700 text-lg w-6 h-6 border border-red-700 rounded-md bg-transparent mt-05rem filter-button"
                        title="Remove filter condition"
                        v-on:click="e => { e.preventDefault(); removeAndShift(index); }">
                        ×
                      </button>

                      <!-- Show a warning div if the filter is incomplete -->
                      <span
                        v-if="topLevelFilterOptions[index] != null && (filterOperators[index] == null || filterValues[index] == null || ((topLevelFilterOptions[index] == 'returnDT' || topLevelFilterOptions[index] == 'launchDT') && filterValues[index] == ''))"
                        class="tooltip-custom items-center justify-center text-red-700 text-sml border border-red-700 rounded-md bg-transparent py-2 px-4 mt-05rem">
                        (!)
                        <span class="tooltiptext-custom speech-bubble text-sml text-gray-500">This filter condition is incomplete,<br/>and will not be applied.</span>
                      </span>
                    </div>
                    <div class="ml-2rem filter-container focus-within:z-10" 
                      v-if="orFilterConditionsCount[index] != null && orFilterConditionsCount[index] > 0"
                      v-for="(orItem, orIndex) in generateOrFiltersConditionsArr(index)">
                        <!-- Separator -->
                        <div class="text-gray-400 mt-05rem mr-1rem"><span class="text-gray text-lg">⮡ </span> OR</div>

                        <!-- Top level filter options -->
                        <select v-model="orFilterTopLevelOptions[index][orIndex]"
                          class="filter-select border-gray-300 text-gray-400"
                          v-on:change="handleOrFilterChange" :id="'filter-top-' + index + '-' + orIndex">
                          <option v-for="validOption in getTopLevelFilterOptions()" v-bind:key="validOption" v-bind:value="validOption.value">
                            {{ validOption.text }}
                        </select>

                        <!-- Operator options -->
                        <select
                          v-if="orFilterTopLevelOptions[index][orIndex] != null" v-model="orFilterOperators[index][orIndex]"
                          class="filter-select border-gray-300 text-gray-400"
                          v-on:change="handleOrFilterChange" :id="'filter-op-' + index + '-' + orIndex">
                          <option v-for="validOperator in getFilterOpOptions(orFilterTopLevelOptions[index][orIndex])" v-bind:key="validOperator" v-bind:value="validOperator.value">
                            {{ validOperator.text }}
                        </select>

                        <!-- Value options -->
                        <select v-model="orFilterValues[index][orIndex]"
                          v-if="orFilterTopLevelOptions[index][orIndex] != null && orFilterOperators[index][orIndex] != null && isBaseFilter(orFilterTopLevelOptions[index][orIndex])"
                          class="filter-select border-gray-300 text-gray-400"
                          v-on:change="handleOrFilterChange" :id="'filter-value-' + index + '-' + orIndex">
                          <option v-for="validValue in getFilterValueOptions(orFilterTopLevelOptions[index][orIndex])" :class="validValue.styleClass ?? ''" v-bind:key="validValue" v-bind:value="validValue.value">
                            {{ validValue.text }}
                        </select>

                        <!-- Drop Selectors
                          opens a custom modal -->
                        <input type="text" v-on:click="e => {e.preventDefault(); openDropFilterMenu(index, orIndex);}"
                          v-if="orFilterTopLevelOptions[index][orIndex] != null && orFilterOperators[index][orIndex] != null && orFilterTopLevelOptions[index][orIndex] == 'drops'"
                          class="filter-select w-auto border-gray-300 text-gray-400" placeholder="Click to select"
                          v-bind:value="dOrFilterValues[index][orIndex]" readonly
                          :id="'filter-value-' + index + '-' + orIndex"
                        >

                        <!-- Target Selectors
                          opens a custom modal -->
                        <input type="text" v-on:click="e => {e.preventDefault(); openTargetFilterMenu(index, orIndex);}"
                          v-if="orFilterTopLevelOptions[index][orIndex] != null && orFilterOperators[index][orIndex] != null && orFilterTopLevelOptions[index][orIndex] == 'target'"
                          class="filter-select w-auto border-gray-300 text-gray-400" placeholder="Click to select"
                          v-bind:value="dOrFilterValues[index][orIndex]" readonly
                          :id="'filter-value-' + index + '-' + orIndex"
                        >

                        <!-- Launch/Return Date Selectors
                          Min: 20 January 2021  
                          Max: Today + 5 days -->
                        <input type="date" min="2021-01-20" :max="new Date().toISOString().split('T')[0]" v-model="orFilterValues[index][orIndex]"
                          class="filter-select border-gray-300 text-gray-400"
                          v-if="orFilterTopLevelOptions[index][orIndex] != null && orFilterOperators[index][orIndex] != null && (orFilterTopLevelOptions[index][orIndex] == 'launchDT' || orFilterTopLevelOptions[index][orIndex] == 'returnDT')"
                          v-on:change="handleOrFilterChange" :id="'filter-value-' + index + '-' + orIndex" required
                        >
                        <!-- Clear button-->
                        <button 
                          class="mr-1rem flex items-center justify-center text-red-700 text-lg w-6 h-6 border border-red-700 rounded-md bg-transparent mt-05rem filter-button"
                          title="Remove filter condition"
                          v-on:click="e => {e.preventDefault(); removeOrAndShift(index, orIndex); }">
                          ×
                        </button>
                        <!-- Show a warning div if the filter is incomplete -->
                        <span
                          v-if="orFilterTopLevelOptions[index][orIndex] != null && (orFilterOperators[index][orIndex] == null || orFilterValues[index][orIndex] == null)"
                          class="tooltip-custom items-center justify-center text-red-700 text-sml border border-red-700 rounded-md bg-transparent py-2 px-4 mt-05rem">
                          (!)
                          <span class="tooltiptext-custom speech-bubble text-sml text-gray-500">This filter condition is incomplete,<br/>and will not be applied.</span>
                        </span>
                    </div>
                  </div>
                </div>

                <!-- Create a 2 px visible gray line that goes across the entire div-->
                <hr class="mt-1rem w-full">

                <button
                  v-if="idle"
                  ref="applyFilterToData"
                  id="filter-apply-button"
                  type="submit"
                  class="mt-05rem mr-1rem -ml-px relative p-0.5 text-center space-x-2 px-3 py-1 border border-gray-300 text-sm font-medium rounded-md text-gray-400 bg-darkerer hover:bg-dark_tab_hover disabled:opacity-50 disabled:hover:darker_tab_hover disabled:hover:cursor-not-allowed focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                  v-bind:disabled="(dataFilter === [] || dataBeingFiltered || !filterHasChanged)"
                >
                  Apply Filter
                </button>

                <!-- Show loading gif while filter is being applied -->
                <span v-if="dataBeingFiltered" class="text-green-700 mt-05rem">
                  <i>
                    <img src="images/loading.gif" alt="Loading..." class="target-ico" />
                    Applying filter, please wait...
                  </i>
                </span>
                <!-- Show the time that it took to apply the filter -->
                <span v-if="!dataBeingFiltered && filterApplyTime != ''" class="text-green-700 mt-05rem">
                  <i>
                    Filtered in {{ filterApplyTime }} <span class="text-gray-500">
                      ( <span class="text-green-700">
                        {{ filteredMissions.length }} shown<span class="text-gray-500">,</span> {{ allLoadedMissions.length - filteredMissions.length }} filtered out 
                      </span>)
                    </span>
                  </i>
                </span>
              </form>
            </div>
            <hr class="mt-1rem invisible">
            <div class="ml-05rem">
              <span class="font-bold text-gray-400">Missions: </span>
              <button v-if="filteredMissions.length != 0" id="toggleResultsButton" class="text-base toggle-link" type="button" v-on:click="toggleElements($event)">{{(allVisible ? 'Collapse All' : 'Expand All')}}</button>
              <span class="mr-5">
                <label for="viewByDateCB" class="ext-opt-label">Separate missions by day</label>
                <input id="viewByDateCB" type="checkbox" v-model="viewByDate" class="ext-opt-check"/>
              </span>
              <span class="mr-5">
                <label for="viewMissionTimesCB" class="ext-opt-label">Show launch times</label>
                <input id="viewMissionTimesCB" type="checkbox" v-model="viewMissionTimes" class="ext-opt-check"/>
              </span>
              <span class="mr-5">
                <label for="recolorDCCB" class="ext-opt-label">Re-color dubcaps</label>
                <input id="recolorDCCB" type="checkbox" v-model="recolorDC" class=" ext-opt-check"/>
              </span>
              <span class="mr-5">
                <label for="useGifsForRarity" class="ext-opt-label">Particle GIFs for rarity</label>
                <input id="useGifsForRarity" type="checkbox" v-model="useGifsForRarity" class="ext-opt-check"/>
              </span>
            </div>
            <div ref="resultsDiv" class="relative h-screen">
              <div class="filter-form text-lg" v-if="filteredMissions.length == 0">
                <span class="mt-05rem ml-1rem">No missions to display.</span>
              </div>
              <div v-else id="missionListDiv" :style="'max-height: ' + calculateMaxMissionDivHeight() + '%;'" class="mt-05rem overflow-y-auto px-2 py-1 shadow-sm block text-xs font-mono text-gray-500 bg-darkest rounded-md">
                <template v-for="(yearVF, yearIndex) in groupedMissions" :key="yearIndex">
                  <span :class="'text-lg font-bold mr-05rem ledger-underline'">{{ groupedYearArray[yearIndex].year }}</span>
                  <button class="tb-c text-lg toggle-link" type="button" v-on:click="toggleElements($event, groupedYearArray[yearIndex])">
                    {{(groupedYearArray[yearIndex].enabled ? 'Collapse' : 'Expand')}}
                  </button>
                  <div v-if="groupedYearArray[yearIndex].enabled" v-for="(monthVF, monthIndex) in yearVF" :key="monthIndex">
                    <div class="mt-1rem ml-2rem">
                      <span class="text-base font-bold mr-05rem ledger-underline">{{ groupedYearArray[yearIndex].year }}-{{ groupedMonthArray[yearIndex][monthIndex].month }}</span>
                      <button class="tb-c text-base toggle-link" type="button" v-on:click="toggleElements($event, groupedYearArray[yearIndex], groupedMonthArray[yearIndex][monthIndex])">
                       {{(groupedMonthArray[yearIndex][monthIndex].enabled ? 'Collapse' : 'Expand')}}
                      </button>
                      <div v-if="groupedMonthArray[yearIndex][monthIndex].enabled" v-for="(dayVF, dayIndex) in monthVF" :key="dayIndex">
                        <div class="mt-1rem ml-2rem">
                          <span v-if="viewByDate" class="text-sm font-bold ledger-underline">
                            {{ groupedYearArray[yearIndex].year }}-{{ groupedMonthArray[yearIndex][monthIndex].month }}-{{ groupedDayArray[yearIndex][monthIndex][dayIndex].day }}
                          </span> <button v-if="viewByDate" class="tb-c text-sm mr-05rem toggle-link" type="button" v-on:click="toggleElements($event, groupedYearArray[yearIndex], groupedMonthArray[yearIndex][monthIndex], groupedDayArray[yearIndex][monthIndex][dayIndex])">
                            {{(groupedDayArray[yearIndex][monthIndex][dayIndex].enabled ? 'Collapse' : 'Expand')}}
                          </button>
                          <div class="mt-1rem mission-grid">
                            <div v-if="(viewByDate && groupedDayArray[yearIndex][monthIndex][dayIndex].enabled) || (!viewByDate && groupedMonthArray[yearIndex][monthIndex].enabled)"
                              class="text-sm mission-item"
                              v-for="(mission, missionIndex) in dayVF" :key="missionIndex">
                              <button 
                                class="text-sm mr-5 font-bold btn btn-outline-dark bg-transparent"
                                type="button" v-on:click="viewSpecificMission(mission.missionId)"
                              >
                                <span v-if="!viewByDate" :class="(missionBeingViewed == mission.missionId ? 'text-selectedmission' : ((recolorDC && mission.isDubCap) ? 'text-dubcap' : 'text-gray-400'))">
                                  {{padDateOut(groupedYearArray[yearIndex].year, groupedMonthArray[yearIndex][monthIndex].month, groupedDayArray[yearIndex][monthIndex][dayIndex].day)}}
                                </span>
                                <span v-if="viewMissionTimes" :class="(missionBeingViewed == mission.missionId ? 'text-selectedmissiondarker' : ((recolorDC && mission.isDubCap) ? 'text-dubcapdarker' : 'text-gray-500'))">
                                  {{' ' + mission.launchTime}}
                                </span>
                                <span class="text-gray-400 ml-05rem">
                                  <span :class="durToTextClass(mission.durationType)">{{shipToName(mission.ship)}}</span>
                                  <span v-if="mission.level != null && mission.level > 0"> ({{mission.level}}<span class="text-goldenstar">★</span>)</span>
                                  <img v-if="targetImage(mission.target) != ''" v-bind:src="targetImage(mission.target)[0]" :alt="targetImage(mission.target)[1]" class="target-ico" />
                                </span>
                              </button>
                            </div>
                          </div>                        
                        </div>
                      </div>
                    </div>
                  </div>
                  <br/>
                  <hr v-if="groupedYearArray[yearIndex].enabled" class="pt-3rem pb-3rem invisible mt-1">
                </template>
              </div>
            </div>
          </div>
        </div>

        <div v-show="activeTab === UITab.LifetimeDrops" class="flex-1 flex flex-col w-full mx-auto px-4 space-y-3 overflow-hidden bg-darker">
          <div class="mt-0i" ref="selectLifetimeAccountForm" v-if="doesDataExist">
            <form
              id="lifetimeAccountForm" name="lifetimeAccountForm" class="select-form"
              v-on:submit="event => {
                event.preventDefault();
                viewLifetimeDropsOfEid();
            }">
            <!-- lifetimeAccountSelectRef, lifetimeAccountInputRef, openLifetimeAccountDropdown, lifetimeAccountDropdownOpen, selectLifetimeAccount, viewLifetimeAccountSubmitRef -->
              <div ref="lifetimeAccountSelectRef" class="relative flex-grow focus-within:z-10">
                <!-- Overlay to tag inmput with number of missions -->
                <div v-if="selectedLifetimeAccount != null && objectedExistingData.find(acc => acc.id == selectedLifetimeAccount) != null" class="ledger-input-overlay">
                  <span class="invisible whitespace-pre">
                    {{ objectedExistingData.find(acc => acc.id == selectedLifetimeAccount)?.id }}
                  </span> (<span :style="'color: #' + objectedExistingData.find(acc => acc.id == selectedLifetimeAccount)?.accountColor" >
                      {{ objectedExistingData.find(acc => acc.id == selectedLifetimeAccount)?.nickname }} {{ objectedExistingData.find(acc => acc.id == selectedLifetimeAccount)?.ebString }}
                    </span> - {{ objectedExistingData.find(acc => acc.id == selectedLifetimeAccount)?.missionCount }} missions)
                </div>

                <input
                  ref="lifetimeAccountInputRef"
                  type="text"
                  class="drop-select border-gray-300"
                  placeholder="Select an account"
                  v-bind:value="selectedLifetimeAccount"
                  v-on:focus="openLifetimeAccountDropdown"
                  v-on:input="selectedLifetimeAccount = $event.target.value"
                >
                <ul
                  v-if="lifetimeAccountDropdownOpen && objectedExistingData.length > 0"
                  class="ledger-list focus:outline-none sm:text-sm"
                  tabindex="-1"
                >
                  <li
                    v-for="account in objectedExistingData"
                    v-bind:key="account.id" class="drop-opt"
                    v-on:click="selectLifetimeAccount(account)"
                  >
                    {{account.id}} (<span :style="'color: #' + account.accountColor">{{ account.nickname }} {{ account.ebString }}</span> - {{ account.missionCount }} missions)
                  </li>
                </ul>
              </div>
              <button class="-ml-px relative w-20 text-center space-x-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-r-md text-gray-400 filter-button"
              v-if="idle" ref="viewLifetimeAccountSubmitRef" type="submit" v-bind:disabled="(selectedLifetimeAccount === null || selectedLifetimeAccount == '' || objectedExistingData.find(a => a.id == selectedLifetimeAccount) == null || eidMissionsBeingLoaded)">
                View
              </button>
            </form>
            <div class="mt-1rem mb-1rem">
              <span class="text-red-700 border border-red-700 rounded-md mb-1 py-2 px-4">
                This will load all missions for the selected account, and may take a <i>long while</i>.
              </span>
            </div>
            <div v-if="lifetimeState !== LifetimeLoadState.Idle" class="text-gray-400">
              <div v-if="lifetimeState == LifetimeLoadState.FetchingIds">
                Fetching mission IDs...
              </div>
              <div v-else-if="lifetimeState === LifetimeLoadState.LoadingMissionData">
                Loading missions... {{ lifetimeDropsLoadedProgress.loadedCount }}/{{ lifetimeDropsLoadedProgress.totalCount }}
              </div>
              <div v-else-if="lifetimeState === LifetimeLoadState.CoalescingMissionData">
                Coalescing missions... {{ lifetimeDropsLoadedProgress.loadedCount }}/{{ lifetimeDropsLoadedProgress.totalCount }}
              </div>
              <div v-else-if="lifetimeState === LifetimeLoadState.Success">
                <span class="text-green-500">Success</span>
              </div>
              <div v-else-if="lifetimeState === LifetimeLoadState.Failed">
                <span class="text-red-700">Failed</span>
              </div>
              <div class="h-3 relative rounded-full overflow-hidden mt-1">
                <div class="w-full h-full bg-gray-200 absolute"></div>
                <div class="h-full absolute rounded-full bg-green-500"
                  v-bind:style="{ width: lifetimeDropsLoadedProgress.percentageDone }"
                ></div>
              </div>
            </div>
            <div v-if="lifetimeDrops.length > 0 && !lifetimeDropsBeingLoaded"
              class="mt-05rem px-2 py-1 shadow-sm block text-xs font-mono text-gray-500 bg-darkest rounded-md text-center overflow-auto">
              <span class="ledger-underline">Data Coalesced from {{ objectedExistingData.find(a => a.id == selectedLifetimeAccount).missionCount }} Missions</span>
            </div>
          </div>
          <div class="text-center mt-3rem rounded-md border border-red-700 py-2" ref="noDataToView" v-else>
            <span class="text-red-700"> No mission data has been loaded yet.<br>Please <b>Fetch</b> from the </span><button type="button" class="btn-link" v-on:click="activeTab = UITab.Ledger" ><span class="text-blue-500 ledger-underline font-bold">Ledger tab</span></button><span class="text-red-700"> and then come back here.</span>
          </div>
        </div>

        <footer class="text-center text-sm text-gray-500">
          <a
            v-external-link
            href="https://github.com/DavidArthurCole/EggLedger"
            target="_blank"
            class="url-link"
            >EggLedger</a
          >
          v{{ appVersion }} by @<a
            v-external-link
            href="https://github.com/fanaticscripter"
            target="_blank"
            class="url-link"
            >mk2</a
          > & @<a
            v-external-link
            href="https://github.com/DavidArthurCole"
            target="_blank"
            class="url-link"
            >DavidArthurCole</a
          >
          <span v-if="appHasUpdate != ''" class="text-red-700">
            (<a
              v-external-link
              href="https://github.com/DavidArthurCole/EggLedger/releases/latest"
              target="_blank"
              class="text-red-700 hover:text-red-800 ledger-underline"
              >New version [{{appHasUpdate}}] available!</a
            >)</span
          >
        </footer>
      </div>
    </div>

    <script>
      // Global bindings from the go side:
      // - appVersion()
      // - appDirectory()
      // - appIsInForbiddenDirectory()
      // - appIsTranslocated()
      // - knownAccounts()
      // - fetchPlayerData(playerId string)
      // - stopFetchingPlayerData()
      // - openFile(file string)
      // - openFileInFolder(file string)
      // - openURL(url string)
      // - checkForUpdates()

      //Daveed additions :^)
      // - doesDataExist(): bool
      // - getExistingData(): []string
      // - filterWarningRead(): void

      // Interrupt worker if the page is reloaded or closed.
      window.addEventListener('beforeunload', async () => {
        await window.stopFetchingPlayerData();
      });

      (async function () {
        const appVersion = await window.appVersion();
        const appDirectory = await window.appDirectory();
        const appIsInForbiddenDirectory = await window.appIsInForbiddenDirectory();
        const appIsTranslocated = await window.appIsTranslocated();
        const previouslyKnownAccounts = (await window.knownAccounts()) ?? [];

        const UITab = {
          Ledger: 'Ledger',
          ViewData: 'View Mission Data',
          LifetimeDrops: 'Lifetime Drops',
          About: 'About',
          Donate: 'Donate',
        };

        const AppState = {
          AwaitingInput: 'AwaitingInput',
          FetchingSave: 'FetchingSave',
          FetchingMissions: 'FetchingMissions',
          ExportingData: 'ExportingData',
          Success: 'Success',
          Failed: 'Failed',
          Interrupted: 'Interrupted',
        };

        const LifetimeLoadState = {
          Idle: 'Idle',
          FetchingIds: 'FetchingIds',
          LoadingMissionData: 'LoadingMissionData',
          CoalescingMissionData: 'CoalescingMission',
          Success: 'Success',
          Failed: 'Failed',
        }

        function normalizePlayerId(id) {
          id = id.trim();
          if (id.match(/^EI[0-9]{16}$/i)) {
            return id.toUpperCase();
          }
          return id;
        }

        function isIdle(state) {
          return ![
            AppState.FetchingSave,
            AppState.FetchingMissions,
            AppState.ExportingData,
          ].includes(state);
        }

        function hhmmss(date) {
          return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
        }

        function padDateOut(year, month, day){
          if(month < 10) month = "0" + month;
          if(day < 10) day = "0" + day;
          return year + "-" + month + "-" + day;
        }

        function durToName(dur){
          if(dur === "" || dur === null || dur === undefined){
            return "";
          }else{
            switch(dur){
              case 0: return "Short";
              case 1: return "Standard";
              case 2: return "Extended";
              case 3: return "Tutorial";
              default: return "Unknown";
            }
          }
        }

        function shipToName(ship){
          if(ship === "" || ship === null || ship === undefined){
            return "";
          }else{
            switch(ship){
              case 0: return "Chicken One";
              case 1: return "Chicken Nine";
              case 2: return "Chicken Heavy";
              case 3: return "BCR";
              case 4: return "Quintillion Chicken";
              case 5: return "Cornish-Hen Corvette";
              case 6: return "Galeggtica";
              case 7: return "Defihent";
              case 8: return "Voyegger";
              case 9: return "Henerprise";
              default: return "Unknown";
            }
          }
        }

        const isBaseFilter = (filterOp) => {
          return(
            filterOp != 'launchDT' &&
            filterOp != 'returnDT' &&
            filterOp != 'drops' &&
            filterOp != 'target'
          );
        };

        const filterWarningRead = Vue.ref((await window.filterWarningRead()) ?? false);
        const hideFilterWarning = Vue.ref(false);
        const dismissFilterWarning = async () => {
          await window.setFilterWarningRead(true);
          hideFilterWarning.value = true;
        }

        const app = Vue.createApp({
          setup() {
            // ===== Tab =====
            const activeTab = Vue.ref(UITab.Ledger);

            // ===== Player ID input and dropdown =====
            const knownAccounts = Vue.ref(previouslyKnownAccounts);
            const playerId = Vue.ref(previouslyKnownAccounts[0]?.id ?? '');
            const isPlayerIdValid = Vue.computed(() => { return /(^$)|(^EI[0-9]{16}$)/.test(normalizePlayerId(playerId.value)); });
            const nicknameForSelectedPlayerId = Vue.computed(() => { return knownAccounts.value.find(acc => acc.id === normalizePlayerId(playerId.value))?.nickname ?? '';});

            const selectedMissionAccount = Vue.ref(null);
            Vue.watch(selectedMissionAccount, async () => { if(!/^EI[0-9]{16}$/.test(selectedMissionAccount?.value ?? "")) selectedMissionAccount.value = ""; });

            const selectedLifetimeAccount = Vue.ref(null);
            Vue.watch(selectedLifetimeAccount, async () => { if(!/^EI[0-9]{16}$/.test(selectedLifetimeAccount?.value ?? "")) selectedLifetimeAccount.value = ""; });

            // I spent three fucking hours trying to figure out why I couldn't type into a fucking input. 
            // It was this. Fucking. Kill. Me.
            // The handleFocus event listener gets nuked globally when the drop selector opens
            const handleFocus = () => {
              const active = document.activeElement;
              if (!playerIdSelectRef?.value?.contains(active)) closePlayerIdDropdown();
              if (!viewMissionAccountSelectRef?.value?.contains(active)) closeMissionsViewAccountDropdown();
              if (!lifetimeAccountSelectRef?.value.contains(active)) closeLifetimeAccountDropdown();
            };

            const handleMousedown = event => {
              const target = event.target;
              if (!playerIdSelectRef.value?.contains(target)) closePlayerIdDropdown();
              if (!viewMissionAccountSelectRef?.value?.contains(target)) closeMissionsViewAccountDropdown();
              if(!lifetimeAccountSelectRef?.value?.contains(target)) closeLifetimeAccountDropdown();
            };

            Vue.onMounted(() => {
              window.addEventListener('mousedown', handleMousedown);
              window.addEventListener('focus', handleFocus, true);
            });
            Vue.onUnmounted(() => {
              window.removeEventListener('mousedown', handleMousedown);
              window.removeEventListener('focus', handleFocus, true);
            });

            const targetSelectList = Vue.ref([]);
            const targetFilterSelectedIndex = Vue.ref(null);
            const targetFilterSelectedOrIndex = Vue.ref(null);
            const targetFilterMenuOpen = Vue.ref(false);
            const openTargetFilterMenu = (index, orIndex) => {
              window.removeEventListener('focus', handleFocus, true);
              targetSelectList.value = getFilterValueOptions('target');
              targetFilterSelectedIndex.value = index;
              targetFilterSelectedOrIndex.value = orIndex ?? null;
              targetFilterMenuOpen.value = true;
              const el = document.querySelector('.overlay-target');
              el.style.display = 'flex';
              //Toggle the hidden class on the overlay
              el.classList.remove('hidden');
              document.getElementById('target-search').focus();
            };
            const closeTargetFilterMenu = () => {
              window.addEventListener('focus', handleFocus, true);
              targetSearchTerm.value = "";
              targetFilterSelectedIndex.value = null;
              targetFilterSelectedOrIndex.value = null;
              targetFilterMenuOpen.value = false;
              const el = document.querySelector('.overlay-target');
              el.style.display = 'none';
              //Toggle the hidden class on the overlay
              el.classList.add('hidden');
            };
            const targetSearchTerm = Vue.ref("");
            Vue.watch(targetSearchTerm, () => {
              targetSelectList.value = getFilterValueOptions('target').filter(target => target.text.toLowerCase().includes(targetSearchTerm.value.toLowerCase()));
            });
            const selectTargetFilter = (target) => {
              const newValue = target.value.toString().split('.')[0];
              if(targetFilterSelectedIndex.value != null){
                if(targetFilterSelectedOrIndex.value == null){
                  filterValues.value[targetFilterSelectedIndex.value] = newValue;
                  dFilterValues.value[targetFilterSelectedIndex.value] = target.text;
                  handleFilterChange(`filter-value-${targetFilterSelectedIndex.value}`);
                  document.getElementById(`filter-value-${targetFilterSelectedIndex.value}`).size = target.text.length;
                }else{
                  orFilterValues.value[targetFilterSelectedIndex.value][targetFilterSelectedOrIndex.value] = newValue;
                  dOrFilterValues.value[targetFilterSelectedIndex.value][targetFilterSelectedOrIndex.value] = target.text;
                  handleOrFilterChange(`filter-value-${targetFilterSelectedIndex.value}-${targetFilterSelectedOrIndex.value}`);
                  document.getElementById(`filter-value-${targetFilterSelectedIndex.value}-${targetFilterSelectedOrIndex.value}`).size = target.text.length;
                }
              }
              closeTargetFilterMenu();
            };

            const dropSelectList = Vue.ref([]);
            const dropFilterSelectedIndex = Vue.ref(null);
            const dropFilterSelectedOrIndex = Vue.ref(null);
            const dropFilterMenuOpen = Vue.ref(false);
            const openDropFilterMenu = (index, orIndex) => {
              window.removeEventListener('focus', handleFocus, true);
              dropSelectList.value = getFilterValueOptions('drops');
              dropFilterSelectedIndex.value = index;
              dropFilterSelectedOrIndex.value = orIndex ?? null;
              dropFilterMenuOpen.value = true;
              const el = document.querySelector('.overlay-drop');
              el.style.display = 'flex';
              //Toggle the hidden class on the overlay
              el.classList.remove('hidden');
              document.getElementById('drop-search').focus();
            };
            const closeDropFilterMenu = () => {
              window.addEventListener('focus', handleFocus, true);
              dropSearchTerm.value = "";
              dropFilterSelectedIndex.value = null;
              dropFilterSelectedOrIndex.value = null;
              dropFilterMenuOpen.value = false;
              const el = document.querySelector('.overlay-drop');
              el.style.display = 'none';
              //Toggle the hidden class on the overlay
              el.classList.add('hidden');
            };
            const dropSearchTerm = Vue.ref("");
            Vue.watch(dropSearchTerm, () => {
              dropSelectList.value = getFilterValueOptions('drops').filter(drop => drop.text.toLowerCase().includes(dropSearchTerm.value.toLowerCase()));
            });
            const selectDropFilter = (drop) => {
              const newValue = drop.value.toString().split('.')[0];
              if(dropFilterSelectedIndex.value != null){
                if(dropFilterSelectedOrIndex.value == null){
                  filterValues.value[dropFilterSelectedIndex.value] = newValue;
                  dFilterValues.value[dropFilterSelectedIndex.value] = drop.text;
                  handleFilterChange(`filter-value-${dropFilterSelectedIndex.value}`);
                  document.getElementById(`filter-value-${dropFilterSelectedIndex.value}`).size = drop.text.length;
                }else{
                  orFilterValues.value[dropFilterSelectedIndex.value][dropFilterSelectedOrIndex.value] = newValue;
                  dOrFilterValues.value[dropFilterSelectedIndex.value][dropFilterSelectedOrIndex.value] = drop.text;
                  handleOrFilterChange(`filter-value-${dropFilterSelectedIndex.value}-${dropFilterSelectedOrIndex.value}`);
                  document.getElementById(`filter-value-${dropFilterSelectedIndex.value}-${dropFilterSelectedOrIndex.value}`).size = drop.text.length;
                }
              }
              closeDropFilterMenu();
            };

            const lifetimeAccountSelectRef = Vue.ref(null);
            const lifetimeAccountInputRef = Vue.ref(null);
            const lifetimeAccountSubmitRef = Vue.ref(null);
            const lifetimeAccountDropdownOpen = Vue.ref(false);
            const openLifetimeAccountDropdown = () => { lifetimeAccountDropdownOpen.value = true; };
            const closeLifetimeAccountDropdown = () => {
              lifetimeAccountDropdownOpen.value = false;
              if (selectedLifetimeAccount.value != null && selectedLifetimeAccount.value.trim() !== '' && lifetimeAccountSubmitRef.value !== null) lifetimeAccountSubmitRef.value.focus();
              else lifetimeAccountInputRef.value?.blur();
            };
            const selectLifetimeAccount = account => {
              closeLifetimeAccountDropdown();
              selectedLifetimeAccount.value = account.id;
            };


            const lifetimeDrops = Vue.ref([]);
            const lifetimeState = Vue.ref(LifetimeLoadState.Idle);
            const lifetimeDropsBeingLoaded = Vue.ref(false);
            const lifetimeDropsLoadedProgress = Vue.ref({
              percentageDone: '0%',
              loadedCount: 0,
              totalCount: 0,
            });
            const viewLifetimeDropsOfEid = async () => {
              lifetimeDropsBeingLoaded.value = true;
              lifetimeState.value = LifetimeLoadState.FetchingIds;
              const idsJson = await window.getMissionIds(selectedLifetimeAccount.value);
              if(idsJson == null || idsJson == ''){
                lifetimeState.value = LifetimeLoadState.Failed;
                lifetimeDropsBeingLoaded.value = false;
                return;
              }
              const ids = JSON.parse(idsJson);
              lifetimeState.value = LifetimeLoadState.LoadingMissionData;
              const missions = [];
              lifetimeDropsLoadedProgress.value.totalCount = ids.length;
              for (const id of ids) {
                const mission = await getSpecificMissionData(selectedLifetimeAccount.value, id, false);
                if (mission != null) {
                  missions.push(mission);
                }
                lifetimeDropsLoadedProgress.value.percentageDone = `${(missions.length / ids.length) * 100}%`;
                lifetimeDropsLoadedProgress.value.loadedCount++;
              }
              lifetimeState.value = LifetimeLoadState.CoalescingMissionData;
              // TODO: Coalesce the artifacts, stones, and stone fragments from each mission in missions
              //  To match a coalesce for [x] - level, id, and rarity
              //  If two [x] have the same level, id, and rarity, they are the same, add their .quantity together

              lifetimeDropsBeingLoaded.value = false;
            };

            const viewMissionAccountSelectRef = Vue.ref(null);
            const viewMissionAccountInputRef = Vue.ref(null);
            const viewMissionAccountSubmitRef = Vue.ref(null);
            const viewMissionAccountDropdownOpen = Vue.ref(false);
            const openMissionsViewAccountDropdown = () => { viewMissionAccountDropdownOpen.value = true; };
            const closeMissionsViewAccountDropdown = () => {
              viewMissionAccountDropdownOpen.value = false;
              if (selectedMissionAccount.value != null && selectedMissionAccount.value.trim() !== '' && viewMissionAccountSubmitRef.value !== null) viewMissionAccountSubmitRef.value.focus();
              else viewMissionAccountInputRef.value?.blur();
            };
            const selectViewAccount = account => {
              closeMissionsViewAccountDropdown();
              selectedMissionAccount.value = account.id;
            };

            const playerIdSelectRef = Vue.ref(null);
            const playerIdInputRef = Vue.ref(null);
            const playerIdSubmitRef = Vue.ref(null);
            const playerIdDropdownOpen = Vue.ref(false);
            const openPlayerIdDropdown = () => { playerIdDropdownOpen.value = true; };
            const closePlayerIdDropdown = () => {
              playerIdDropdownOpen.value = false;
              if (playerId.value.trim() !== '' && playerIdSubmitRef.value !== null) playerIdSubmitRef.value.focus();
              else playerIdInputRef.value?.blur();
            };
            const selectPlayerId = id => {
              playerId.value = id;
              closePlayerIdDropdown();
            };
            const getEidProblem = id => {
              const normalizedId = normalizePlayerId(id).toUpperCase();
              if (normalizedId.substring(0, 2) != 'EI') return 'should start with "EI"';
              if (!/^EI[0-9]*$/.test(normalizedId) || normalizedId.length == 2) return 'should be EI + 16 digits';
              if (normalizedId.length != 18) return 'expected 16 digits, found ' + (normalizedId.length - 2);
              return '';
            }

            const isFetching = Vue.ref(false);
            const fetchPlayerData = async () => {
              const normalizedId = normalizePlayerId(playerId.value);
              if (normalizedId !== '') {
                isFetching.value = true;
                await window.fetchPlayerData(normalizedId);
                isFetching.value = false;
              }
            };

            const stopFetchingPlayerData = async () => {
              await window.stopFetchingPlayerData();
              isFetching.value = false;
            };

            // ===== App state =====
            const currentState = Vue.ref(AppState.AwaitingInput);
            const idle = Vue.computed(() => isIdle(currentState.value));

            const missionProgress = Vue.ref({
              total: 0,
              finished: 0,
              finishedPercentage: '0%',
              expectedFinishTimestamp: 0,
              eta: '',
            });
            const getEta = finish => {
              const eta = Math.round(Math.max(finish - Date.now() / 1000, 0));
              const h = Math.floor(eta / 3600).toString();
              const mm = Math.floor((eta % 3600) / 60)
                .toString()
                .padStart(2, '0');
              const ss = Math.floor(eta % 60)
                .toString()
                .padStart(2, '0');
              return `${h}:${mm}:${ss}`;
            };
            let etaIntervalId;
            Vue.onMounted(() => {
              etaIntervalId = setInterval(() => {
                missionProgress.value.eta = getEta(missionProgress.value.expectedFinishTimestamp);
              }, 200);
            });
            Vue.onUnmounted(() => clearInterval(etaIntervalId));

            const exportedFiles = Vue.ref([]);

            // ===== Messages buffer =====
            const messages = Vue.ref([]);
            // Auto scroll messaged buffer to bottom, but only if the user hasn't scrolled up manually.
            const messagesRef = Vue.ref(null);
            const messagesScrolledUp = Vue.ref(false);
            // Check if user scrolled up, before the content changes.
            Vue.watch(
              messages,
              () => {
                const textarea = messagesRef.value;
                messagesScrolledUp.value =
                  textarea.scrollTop + textarea.clientHeight < textarea.scrollHeight;
              },
              { deep: true }
            );
            // Conditionally scroll to bottom after the content changes.
            Vue.watch(
              messages,
              () => {
                const textarea = messagesRef.value;
                if (!messagesScrolledUp.value) {
                  textarea.scrollTop = textarea.scrollHeight;
                }
              },
              { deep: true, flush: 'post' }
            );

            const extractColorSegments = (content) => {
              const regex = /&([a-fA-F0-9]{6})<([^>]+)>/g, segments = [];
              let lastIndex = 0, match;
              while ((match = regex.exec(content)) !== null) {
                if (match.index > lastIndex) segments.push({ text: content.substring(lastIndex, match.index) });
                segments.push({ text: match[2], color: match[1] });
                lastIndex = regex.lastIndex;
              }
              if (lastIndex < content.length) segments.push({ text: content.substring(lastIndex) });
              return segments;
            };

            // ===== Check for updates =====
            const appHasUpdate = Vue.ref("");
            Vue.onMounted(async () => {
              appHasUpdate.value = await window.checkForUpdates();
            });

            // ===== Global bindings =====
            // Bind a bunch of state updater functions to the global scope so that the go side can
            // push state updates.
            window.updateKnownAccounts = accounts => {
              knownAccounts.value = accounts;
            };
            window.updateState = newState => {
              currentState.value = newState;
            };
            window.updateMissionProgress = newProgress => {
              missionProgress.value = {
                ...newProgress,
                eta: getEta(newProgress.expectedFinishTimestamp),
              };
            };
            window.updateExportedFiles = newFiles => {
              exportedFiles.value = newFiles;
            };
            window.emitMessage = (content, isError) => {
              messages.value.push({
                timestamp: new Date(),
                content,
                isError,
              });
            };

            // ===== Setup for 'View Mission Data' Tab =====
            const viewByDate = Vue.ref(false);
            const viewMissionTimes = Vue.ref(true);
            const recolorDC = Vue.ref(false);
            const useGifsForRarity = Vue.ref(true);
            const viewMissionData = Vue.ref({});
            const doesDataExist = Vue.ref(false);
            const existingData = Vue.ref([]); //Empty array of strings
            const objectedExistingData = Vue.computed(() => {
              return existingData.value.map(account => {
                return {
                  id: account.id,
                  nickname: account.nickname,
                  missionCount: account.missionCount,
                  ebString: (account.ebString && account.ebString != "" ? account.ebString : "???"),
                  accountColor: account.accountColor
                };
              }).sort((a, b) => { //sort by missionCount
                if(a.missionCount > b.missionCount) return -1;
                if(a.missionCount < b.missionCount) return 1;
                return 0;
              });
            });
            //Filter [ x ] that have the same `name`, `level`, `specType`, and `rarity`
            // If there are 2 artifacts with the same name, level, specType, and rarity, increment the `count` of the first one, and remove the second one
            const groupedSpecType = (collection) => {
              return collection.reduce((acc, obj) => {
                const key = obj.name + "_" + obj.level + "_" + obj.specType + "_" + obj.rarity;
                if (!acc[key]) {
                  acc[key] = obj;
                  acc[key].count = 1;
                }else{
                  acc[key].count++;
                }
                return acc;
              }, {});
            };
            const sortedGroupedSpecType = (collection) => {
              return Object.values(groupedSpecType(collection)).sort((a, b) => {
                if(a.level > b.level) return -1;
                if(a.level < b.level) return 1;
                if(a.rarity > b.rarity) return -1;
                if(a.rarity < b.rarity) return 1;
                if(a.quality < b.quality) return -1;
                if(a.quality > b.quality) return 1;
                return 0;
              }).reverse();
            };
            const numToDigClass = (num) => {
              const parsedNum = parseInt(num.toString());
              switch (true) {
                case parsedNum <= 9: return "w-onedig";
                case parsedNum > 9 && parsedNum <= 99: return "w-twodig";
                case parsedNum > 99: return "w-threedig";
                default: return "w-onedig";
              }
            };
            const properCase = (string) => {
              string = string.toLowerCase();
              // Capitalize the first letter of each word, unless it is 'of' or 'the'
              const words = string.split(" ");
              for (let i = 0; i < words.length; i++) {
                if (words[i] !== "of" && words[i] !== "the") {
                  words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1);
                }
              }
              const finalString = words.join(" ");
              return finalString.charAt(0).toUpperCase() + finalString.slice(1);
            };
            //Return three strings in an array, the first is the string before the effect, the second is the effect, and the third is the string after the effect
            const boundEffectString = (str) => {
              const match = /\[(.*?)\]/g.exec(str);
              return (!match ? ["?", "?", "?"] : [str.substring(0, match.index), match[1], str.substring(match.index + match[0].length)]);
            };
            const durToTextClass = (dur) => {
              switch(dur){
                case 0: return "text-short";
                case 1: return "text-standard";
                case 2: return "text-extended";
                case 3: return "text-tutorial";
                default: return "";
              }
            };
            const afRarityText = (drop, bypass) => {
              if(drop.specType != 'Artifact' && !bypass) return "";
              switch(drop.rarity){
                case 1: return "Rare";
                case 2: return "Epic";
                case 3: return "Legendary";
                default: return "";
              }
            };
            const afRarityClass = (drop, bypass) => {
              if(drop.specType != 'Artifact' && !bypass) return "";
              const rarity = afRarityText(drop, bypass ?? false);
              return (rarity == "" ? "" : "text-" + rarity.toLowerCase());
            };
            const afBackgroundClass = (af) => {
              switch (af.rarity) {
                case 0: return 'bg-common';
                case 1: return (useGifsForRarity.value ? "bg-cover bg-rare-animated" : 'bg-rare');
                case 2: return (useGifsForRarity.value ? "bg-cover bg-epic-animated" : 'bg-epic')
                case 3: return (useGifsForRarity.value ? "bg-cover bg-legendary-animated" : 'bg-legendary');
                default: return 'bg-common';
              }
            };
            const afExplorerName = (drop, addend) => {
              return drop.name.replace('_FRAGMENT', '').toLowerCase().replace("_", "-") + '-' + (parseInt(drop.level) + addend);
            };
            const closeMissionOverlay = () => {
              const el = document.querySelector('.overlay-mission');
              el.style.display = 'none';
              //Toggle the hidden class on the overlay
              el.classList.add('hidden');
              viewMissionData.value = {};
              missionBeingViewed.value = null;
            };
            const openMissionOverlay = () => {
              const el = document.querySelector('.overlay-mission');
              el.style.display = 'flex';
              //Toggle the hidden class on the overlay
              el.classList.remove('hidden');
            };
            const specPath = (spec, addend) => {
              const fixedName = spec.name.replaceAll("_FRAGMENT", "").replaceAll("ORNATE_GUSSET", "GUSSET").replaceAll("VIAL_MARTIAN_DUST", "VIAL_OF_MARTIAN_DUST");
              return "images/artifacts/" + fixedName + "/" + fixedName + "_" + (parseInt(spec.level) + addend) + ".png";
            };
            const dropPath = (drop) => {
              const addendum = (drop.protoName.indexOf('_STONE') > -1 ? 1 : 0);
              const fixedName = drop.protoName.replaceAll("_FRAGMENT", "").replaceAll("ORNATE_GUSSET", "GUSSET").replaceAll("VIAL_MARTIAN_DUST", "VIAL_OF_MARTIAN_DUST");
              return "artifacts/" + fixedName + "/" + fixedName + "_" + (drop.level + 1 + addendum) + ".png";
            };
            const dropRarityPath = (drop) => {
              switch(drop.rarity){
                case 0: return "";
                case 1: return "images/rare.gif";
                case 2: return "images/epic.gif";
                case 3: return "images/legendary.gif";
                default: return "";
              }
            }
            const refreshExistingData = async () => {
              doesDataExist.value = await window.doesDataExist();
              if(doesDataExist.value) existingData.value = await window.getExistingData();
            };
            Vue.watch((exportedFiles, knownAccounts, previouslyKnownAccounts, currentState), async () => {
              refreshExistingData();
            });
            Vue.onMounted(async () => {
              refreshExistingData();
            });

            const eidMissionsBeingLoaded = Vue.ref(false);
            const loadedEid = Vue.ref(null);
            const loadedAccountMissionsCount = Vue.ref(0);
            const allLoadedMissions = Vue.ref(null);
            const filteredMissions = Vue.ref(null);
            const groupedYearArray = Vue.ref(null);
            const groupedMonthArray = Vue.ref(null);
            const groupedDayArray = Vue.ref(null);
            const groupedMissions = Vue.computed(() => {
              if (filteredMissions.value == null || filteredMissions.value.length === 0) return {};

              // Generate a list of all the years that have missions
              const uniqueYears = [...new Set(filteredMissions.value.map(mission => mission.launchYear))].reverse();
              //Make a copy of the uniqueYears array, and add an enabled property to each year
              groupedYearArray.value = uniqueYears.map(year => { return { year: year, enabled: true}; });

              // Create a 2D array storing months used in each year
              const uniqueMonthsArr = uniqueYears.map(year =>
                [...new Set(filteredMissions.value.filter(mission => mission.launchYear === year).map(mission => mission.launchMonth))].reverse()
              );
              //Make a copy of the uniqueMonthsArr array, and add an enabled property to each month
              groupedMonthArray.value = uniqueMonthsArr.map(year => year.map(month => { return { month: month, enabled: true}; }));

              // Create a 3D array storing days used in each month
              const uniqueDaysArr = uniqueYears.map((year, yearIndex) =>
                uniqueMonthsArr[yearIndex].map(month =>
                  [...new Set(
                    filteredMissions.value
                      .filter(mission => mission.launchYear === year && mission.launchMonth === month)
                      .map(mission => mission.launchDay)
                  )].reverse()
                )
              );
              //Make a copy of the uniqueDaysArr array, and add an enabled property to each day
              groupedDayArray.value = uniqueDaysArr.map((year, yearIndex) => year.map((month, monthIndex) => month.map(day => { return { day: day, enabled: true}; })));

              // Create a 4D array storing all missions in each day
              return uniqueYears.map((year, yearIndex) =>
                uniqueMonthsArr[yearIndex].map((month, monthIndex) =>
                  uniqueDaysArr[yearIndex][monthIndex].map(day =>
                    filteredMissions.value
                      .filter(mission => mission.launchYear === year && mission.launchMonth === month && mission.launchDay === day)
                      .reverse()
                  )
                )
              );
            });

            const allVisible = Vue.ref(true);
            function toggleElements(event, passedYear, passedMonth, passedDay) {
              if(passedYear){
                const year = groupedYearArray.value[groupedYearArray.value.indexOf(passedYear)];
                if(passedMonth){
                  const month = groupedMonthArray.value[groupedYearArray.value.indexOf(passedYear)][groupedMonthArray.value[groupedYearArray.value.indexOf(passedYear)].indexOf(passedMonth)];
                  if(passedDay){
                    const day = groupedDayArray.value[groupedYearArray.value.indexOf(passedYear)][groupedMonthArray.value[groupedYearArray.value.indexOf(passedYear)].indexOf(passedMonth)][groupedDayArray.value[groupedYearArray.value.indexOf(passedYear)][groupedMonthArray.value[groupedYearArray.value.indexOf(passedYear)].indexOf(passedMonth)].indexOf(passedDay)];
                    day.enabled = !day.enabled;
                  } else month.enabled = !month.enabled;
                } else year.enabled = !year.enabled;
              } else { //Toggle all
                allVisible.value = !allVisible.value;
                for (const year of groupedYearArray.value) {
                  year.enabled = allVisible.value;
                  for (const month of groupedMonthArray.value[groupedYearArray.value.indexOf(year)]) {
                    month.enabled = allVisible.value;
                    for (const day of groupedDayArray.value[groupedYearArray.value.indexOf(year)][groupedMonthArray.value[groupedYearArray.value.indexOf(year)].indexOf(month)]) {
                      day.enabled = allVisible.value;
                    }
                  }
                }
              }
            }

            const calculateMaxMissionDivHeight = () => {
              if(hideFilter.value) return '80';
              else{
                //Sum all values in orFilterConditionsCount, ignoring null
                const orsSum = orFilterConditionsCount.value.reduce((a, b) => a + (b || 0), 0);
                const count = (parseInt(filterConditionsCount?.value ?? 1) ?? 1) + orsSum;
                const calc = 80 - ((count == 1 ? 0 : count * 7.0) + 7);
                if(calc < 60) return '60';
                else return calc.toString();
              }
            };

            const viewMissionsOfEid = async () => {
              filterApplyTime.value = ""; //Reset the filter apply time
              loadedAccountMissionsCount.value = objectedExistingData.value.find(acc => acc.id == selectedMissionAccount.value.toString())?.missionCount ?? 0;
              eidMissionsBeingLoaded.value = true;
              const missionsLoadValue = await window.viewMissionsEID(selectedMissionAccount.value.toString());
              if (missionsLoadValue !== "") {
                allLoadedMissions.value = JSON.parse(missionsLoadValue);
                filteredMissions.value = allLoadedMissions.value;
                loadedEid.value = selectedMissionAccount.value.toString();
              }
              eidMissionsBeingLoaded.value = false;
            };

            //==============================================
            // Filter stuff :^)
            //==============================================

            const filterApplyTime = Vue.ref("");
            const filterConditionsCount = Vue.ref(1);
            const topLevelFilterOptions = Vue.ref([]);
            const filterOperators = Vue.ref([]);
            const filterValues = Vue.ref([]);

            const orFilterConditionsCount = Vue.ref([]);
            const orFilterTopLevelOptions = Vue.ref([[]]);
            const orFilterOperators = Vue.ref([[]]);
            const orFilterValues = Vue.ref([[]]);

            const dFilterValues = Vue.ref([]);
            const dOrFilterValues = Vue.ref([[]]);
            //When filterValues changes, keep dFilterValues in sync in terms of size
            Vue.watch(filterValues, 
              () => {
                //Expand dFilterValues to match the size of filterValues, or shrink it if filterValues has shrunk
                dFilterValues.value = filterValues.value.map((filter, index) => {
                  if(dFilterValues.value[index] == undefined) return "";
                  else return dFilterValues.value[index];
                });
              },
              { deep: true }
            );
            //When orFilterValues changes, keep dOrFilterValues in sync in terms of array size
            Vue.watch(orFilterValues, 
              () => {
                //Expand dOrFilterValues to match the size of orFilterValues, or shrink it if orFilterValues has shrunk
                dOrFilterValues.value = orFilterValues.value.map((orFilter, index) => {
                  if(dOrFilterValues.value[index] == undefined) return [];
                  else return dOrFilterValues.value[index].slice(0, orFilter.length);
                });
              },
              { deep: true }
            );

            const dataFilter = Vue.ref([]);
            const orDataFilter = Vue.ref([[]]);
            const hideFilter = Vue.ref(false);
            const filterHasChanged = Vue.ref(false);
            const dataBeingFiltered = Vue.ref(false);

            const possibleTargets = Vue.ref(null);
            const maxQuality = Vue.ref("");
            const durationConfigs = Vue.ref(null);
            const artifactConfigs = Vue.ref(null);
            Vue.onMounted(async () => {
              artifactConfigs.value = JSON.parse(await window.getAfxConfigs());
              maxQuality.value = JSON.parse(await window.getMaxQuality());
              durationConfigs.value = JSON.parse(await window.getDurationConfigs());
              possibleTargets.value = JSON.parse(await window.getPossibleTargets());
            });

            Vue.watch((dataFilter, orDataFilter), async () => {
              filterHasChanged.value = true;
            });

            const getTopLevelFilterOptions = () => {
              return [
                { text: 'Ship', value: 'ship' },
                { text: 'Duration', value: 'duration' },
                { text: 'Level', value: 'level' },
                { text: 'Target', value: 'target' },
                { text: 'Drops/Loot', value: 'drops' },
                { text: 'Launch Date', value: 'launchDT' },
                { text: 'Return Date', value: 'returnDT' },
                { text: 'Double Cap', value: 'dubcap'}
              ]
            }

            const getFilterOpOptions = (topLevel) => {
              switch(topLevel){
                case 'ship':
                case 'duration':
                case 'level': return [
                  { text: 'is', value: '=' },
                  { text: 'is not', value: '!=' },
                  { text: 'greater than', value: '>' },
                  { text: 'less than', value: '<' }
                ];
                case 'target': return [
                  { text: 'is', value: '=' },
                  { text: 'is not', value: '!=' }
                ];
                case 'drops': return [
                  { text: 'contains', value: 'c' },
                  { text: 'does not contain', value: 'dnc' }
                ];
                case 'launchDT':
                case 'returnDT': return [
                  { text: 'on', value: 'on' },
                  { text: 'before', value: 'before' },
                  { text: 'after', value: 'after' }
                ];
                case 'dubcap': return [
                  { text: 'is', value: '=' },
                ];
              }
            }

            const getFilterValueOptions = (topLevel) => {
              switch(topLevel){
                case 'ship': return Array.from({ length: 10 }, (_, index) => ({
                    text: shipToName(index),
                    value: index,
                  }));
                case 'duration': return Array.from({ length: 4 }, (_, index) => ({
                    text: durToName(index),
                    value: index,
                    styleClass: durToTextClass(index)
                  }));
                case 'level': return Array.from({ length: 8 }, (_, index) => ({
                    text: index + '★',
                    value: index
                  }));
                case 'target': return possibleTargets.value.map(target => ({
                    text: target.displayName,
                    value: target.id,
                    imagePath: target.imageString
                  }));
                case 'drops': {
                  const filteredConfigs = artifactConfigs.value.filter(a => a.baseQuality <= maxQuality.value).map(artifact => ({
                    text: artifact.displayName + ((artifact.level == '%') ? '' : (' (T' + (artifact.level + ((artifact.displayName.toLowerCase().indexOf('stone') > -1 && artifact.displayName.toLowerCase().indexOf('fragment') == -1) ? 2 : 1)) + ')')),
                    value: artifact.name + "_" + artifact.level + "_" + artifact.rarity + "_" + artifact.baseQuality,
                    styleClass: (afRarityClass(artifact, true) != "" ? afRarityClass(artifact, true) : 'text-gray-400'),
                    imagePath: dropPath(artifact),
                    rarityGif: dropRarityPath(artifact),
                  }))
                  filteredConfigs.unshift({text: 'Any Legendary', value: '%_%_3_%', styleClass: 'text-legendary', imagePath: 'legendary.gif'});
                  filteredConfigs.unshift({text: 'Any Epic', value: '%_%_2_%', styleClass: 'text-epic', imagePath: 'epic.gif'});
                  filteredConfigs.unshift({text: 'Any Rare', value: '%_%_1_%', styleClass: 'text-rare', imagePath: 'rare.gif'});
                  return filteredConfigs;
                }
                case 'dubcap': return [{ text: 'True', value: 'true' },{ text: 'False', value: 'false' }];
                default: return [];
              }
            }

            //==============================================
            // Filter window functions
            //==============================================
            function generateFilterConditionsArr(){
              return new Array(filterConditionsCount.value);
            };

            function generateOrFiltersConditionsArr(index){
              return new Array(orFilterConditionsCount.value[index]);
            };

            const manualChangeFilter = async () => {
              filterHasChanged.value = true;
            };

            const updateValueStyling = (passedEl, isOr) => {
              //Extract the index from the element's id (split on the last dash)
              const index = parseInt(passedEl.id.split("-")[2]);
              const orIndex = isOr ? parseInt(passedEl.id.split("-").pop()) : null;
              if(isOr && orIndex == null) return;

              const el = document.getElementById('filter-value-' + index + (isOr ? ('-' + orIndex) : ''));
              if(!el) return;
              const existingBorder = el ? 'border-' + el.classList.toString().match(/ border-(.*?)(\s|"|'|$)/)[1].trim() : '';
              const existingText =  el ? 'text-' + el.classList.toString().replace('text-sm', ' ').match(/ text-(.*?)(\s|"|'|$)/)[1].trim() : ''; 
              const isDrops = isOr ? orFilterTopLevelOptions.value[index][orIndex] == 'drops' : topLevelFilterOptions.value[index] == 'drops';
              const dropsValue = isOr ? orFilterValues.value[index][orIndex] : filterValues.value[index];
              const isDuration = isOr ? orFilterTopLevelOptions.value[index][orIndex] == 'duration' : topLevelFilterOptions.value[index] == 'duration';
              var newBorder = '', newText = '';

              if(isDrops && dropsValue != null && dropsValue != ''){
                switch(dropsValue.split("_")[ 2]) {
                  case "0": newBorder = 'border-gray-300'; newText = 'text-gray-400'; break;
                  case "1": newBorder = 'border-rare'; newText = 'text-rare'; break;
                  case "2": newBorder = 'border-epic'; newText = 'text-epic'; break;
                  case "3": newBorder = 'border-legendary'; newText = 'text-legendary'; break;
                  default: newBorder = 'border-gray-300'; newText = 'text-gray-400'; break;
                }
              } else if(isDuration && el.value != ''){
                switch(el.value){
                  case "0": newBorder = 'border-short'; newText = 'text-short'; break;
                  case "1": newBorder = 'border-standard'; newText = 'text-standard'; break;
                  case "2": newBorder = 'border-extended'; newText = 'text-extended'; break;
                  case "3": newBorder = 'border-tutorial'; newText = 'text-tutorial'; break;
                  default: newBorder = 'border-gray-300'; newText = 'text-gray-400'; break;
                }
              } else {
                newBorder = 'border-gray-300';
                newText = 'text-gray-400';
              }
              el.classList.remove(existingBorder);
              el.classList.add(newBorder);
              el.classList.remove(existingText);
              el.classList.add(newText);
            };

            const updateFilterNoReCount = () => {
              filterHasChanged.value = true;
              const newDataFilter = [];
              if(topLevelFilterOptions.value.length != 0 && topLevelFilterOptions.value != null){
                for(let i = 0; i < topLevelFilterOptions.value.length; i++){
                const topLevel = topLevelFilterOptions.value[i];
                const op = filterOperators.value[i];
                const val = filterValues.value[i];
                if(topLevel == null || op == null || (val == null || (topLevel?.indexOf('DT') > -1 && val == ''))) break;
                newDataFilter.push({
                  topLevel: topLevel,
                  op: op,
                  val: val
                });
              } 
              }
              dataFilter.value = newDataFilter;

              const newOrDataFilter = [];
              for(let i = 0; i < orFilterConditionsCount.value.length; i++){
                const orDataFilterArr = [];
                if(orFilterTopLevelOptions.value[i] == null || orFilterOperators.value[i] == null || orFilterValues.value[i] == null) continue;
                for(let j = 0; j < orFilterTopLevelOptions.value[i].length; j++){
                  const topLevel = orFilterTopLevelOptions.value[i][j];
                  const op = orFilterOperators.value[i][j];
                  const val = orFilterValues.value[i][j];
                  if(topLevel == null || op == null || (val == null || (topLevel?.indexOf('DT') > -1 && val == ''))) break;
                  orDataFilterArr.push({
                    topLevel: topLevel,
                    op: op,
                    val: val
                  });
                }
                newOrDataFilter.push(orDataFilterArr);
              }
              orDataFilter.value = newOrDataFilter;
            };

            const handleFilterChange = (event) => {
              const targetEl = event.target ?? document.getElementById(event);
              const targetId = targetEl.id;
              if(targetEl.oldValue == null || targetEl.type == 'date') { 
                updateFilterConditionsCount(); 
                targetEl.oldValue = targetEl.value;
              } else updateFilterNoReCount(); 
              updateValueStyling(targetEl, false);
              if(targetId.indexOf('filter-top-') > -1) {
                const index = parseInt(targetId.split("-").pop());
                if(getFilterValueOptions(targetEl.value).indexOf(filterOperators.value[index]) == -1) filterOperators.value[index] = null;
                if(getFilterValueOptions(targetEl.value).indexOf(filterValues.value[index]) == -1) {
                  filterValues.value[index] = null;
                  dFilterValues.value[index] = null;
                }
              }
            };

            const handleOrFilterChange = (event) => {
              const targetEl = event.target ?? document.getElementById(event);
              const targetId = targetEl.id;
              const index = parseInt(targetId.split("-")[2]);
              const orIndex = parseInt(targetId.split("-").pop()); 
              updateFilterNoReCount();
              updateValueStyling(targetEl, true);
              if(targetId.indexOf('filter-top-') > -1) {
                if(getFilterValueOptions(targetEl.value).indexOf(orFilterOperators.value[index][orIndex]) == -1) orFilterOperators.value[index][orIndex] = null;
                if(getFilterValueOptions(targetEl.value).indexOf(orFilterValues.value[index][orIndex]) == -1) {
                  orFilterValues.value[index][orIndex] = null;
                  dOrFilterValues.value[index][orIndex] = null;
                }
              }
            };

            const updateFilterConditionsCount = () => {
              filterHasChanged.value = true;
              const newDataFilter = [];
              if(topLevelFilterOptions.value.length == 0 || topLevelFilterOptions.value == null) return;
              var maxIndex = 0;
              var set = false;

              for(let i = 0; i < topLevelFilterOptions.value.length; i++){
                const topLevel = topLevelFilterOptions.value[i];
                const op = filterOperators.value[i];
                const val = filterValues.value[i];

                if(topLevel == null || op == null || (val == null || (topLevel?.indexOf('DT') > -1 && val == ''))) {
                  maxIndex = i;
                  break;
                }

                newDataFilter.push({
                  topLevel: topLevel,
                  op: op,
                  val: val
                });

                if(i + 1 == filterConditionsCount.value) {
                  filterConditionsCount.value += 1;
                  set = true;
                }
              }

              if(!set) filterConditionsCount.value = maxIndex + 1;
              dataFilter.value = newDataFilter;
            };

            //==============================================
            // Filter Vue functions
            //==============================================
            const addOr = (index) => {
              if(orFilterConditionsCount.value == null) {
                orFilterConditionsCount.value = []
              };
              if(orFilterConditionsCount.value[index] == null) orFilterConditionsCount.value[index] = 1;
              else orFilterConditionsCount.value[index] += 1;

              if(orFilterTopLevelOptions.value[index] == null) orFilterTopLevelOptions.value[index] = [];
              if(orFilterOperators.value[index] == null) orFilterOperators.value[index] = [];
              if(orFilterValues.value[index] == null) orFilterValues.value[index] = [];

              orFilterTopLevelOptions.value[index].push(null);
              orFilterOperators.value[index].push(null);
              orFilterValues.value[index].push(null);
            };

            const removeAndShift = (index) => {
              //Shift all elements after the one being removed down one
              for(let i = index; i < topLevelFilterOptions.value.length; i++){
                topLevelFilterOptions.value[i] = topLevelFilterOptions.value[i + 1];
                filterOperators.value[i] = filterOperators.value[i + 1];
                filterValues.value[i] = filterValues.value[i + 1];
                dFilterValues.value[i] = dFilterValues.value[i + 1];
              
                orFilterConditionsCount.value[i] = orFilterConditionsCount.value[i + 1];
                orFilterTopLevelOptions.value[i] = orFilterTopLevelOptions.value[i + 1];
                orFilterOperators.value[i] = orFilterOperators.value[i + 1];
                orFilterValues.value[i] = orFilterValues.value[i + 1];
                dOrFilterValues.value[i] = dOrFilterValues.value[i + 1];
              }
              updateFilterConditionsCount();
              updateFilterNoReCount();
              filterHasChanged.value = true;

              //Look for all `filter-top` elements and update their stylings
              document.querySelectorAll('.filter-top').forEach(el => {
                updateValueStyling(el, false);
              });
            }

            const removeOrAndShift = (index, orIndex) => {
              //Shift all elements after the one being removed down one
              for(let i = orIndex; i < orFilterTopLevelOptions.value[index].length; i++){
                orFilterTopLevelOptions.value[index][i] = orFilterTopLevelOptions.value[index][i + 1];
                orFilterOperators.value[index][i] = orFilterOperators.value[index][i + 1];
                orFilterValues.value[index][i] = orFilterValues.value[index][i + 1];
                dOrFilterValues.value[index][i] = dOrFilterValues.value[index][i + 1];
              }
              orFilterConditionsCount.value[index] -= 1;
              if(orFilterConditionsCount.value[index] == 0) orFilterConditionsCount.value[index] = null;
              updateFilterNoReCount();
              filterHasChanged.value = true;
            }

            const testMissionAgainstFilter = async(mission, filter) => {
              var filterPassed = true;
              if(filter.topLevel != null && filter.op != null && filter.val != null){
                switch(filter.topLevel){
                  case 'dubcap': {
                    switch(filter.val){
                      case 'true': if(!mission.isDubCap) filterPassed = false; break;
                      case 'false': if(mission.isDubCap) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'ship': {
                    switch(filter.op){
                      case '=': if(mission.ship != filter.val) filterPassed = false; break;
                      case '!=': if(mission.ship == filter.val) filterPassed = false; break;
                      case '>': if(mission.ship <= filter.val) filterPassed = false; break;
                      case '<': if(mission.ship >= filter.val) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'duration': {
                    switch(filter.op){
                      case '=': if(mission.durationType != filter.val) filterPassed = false; break;
                      case '!=': if(mission.durationType == filter.val) filterPassed = false; break;
                      case '>': if(mission.durationType <= filter.val) filterPassed = false; break;
                      case '<': if(mission.durationType >= filter.val) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'level': {
                    switch(filter.op){
                      case '=': if(mission.level != filter.val) filterPassed = false; break;
                      case '!=': if(mission.level == filter.val) filterPassed = false; break;
                      case '>': if(mission.level <= filter.val) filterPassed = false; break;
                      case '<': if(mission.level >= filter.val) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'target': {
                    switch(filter.op){
                      case '=': if(mission.targetInt != filter.val) filterPassed = false; break;
                      case '!=': if(mission.targetInt == filter.val) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'launchDT': {
                    const launchDay = mission.launchDay.toString().padStart(2, '0');
                    const launchMonth = mission.launchMonth.toString().padStart(2, '0');
                    const launchYear = mission.launchYear.toString().padStart(4, '0');
                    const launchDT = new Date(launchYear + "-" + launchMonth + "-" + launchDay);
                    const filterDT = new Date(filter.val);
                    switch(filter.op){
                      case 'on': if(launchDT.toDateString() != filterDT.toDateString()) filterPassed = false; break;
                      case 'before': if(launchDT >= filterDT) filterPassed = false; break;
                      case 'after': if(launchDT <= filterDT) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'returnDT': {
                    const returnDay = mission.returnDay.toString().padStart(2, '0');
                    const returnMonth = mission.returnMonth.toString().padStart(2, '0');
                    const returnYear = mission.returnYear.toString().padStart(4, '0');
                    const returnDT = new Date(returnYear + "-" + returnMonth + "-" + returnDay);
                    const filterDT = new Date(filter.val);
                    switch(filter.op){
                      case 'on': if(returnDT.toDateString() != filterDT.toDateString()) filterPassed = false; break;
                      case 'before': if(returnDT >= filterDT) filterPassed = false; break;
                      case 'after': if(returnDT <= filterDT) filterPassed = false; break;
                    }
                    break;
                  }
                  case 'drops': {
                    const durConfig = durationConfigs.value[mission.ship].durations[mission.durationType];
                    const maxQuality = durConfig.maxQuality + (durConfig.levelQualityBump * mission.level);
                    const filterQuality = filter.val.split("_")[3]; const qualityBypass = (filterQuality == '%');
                    const filterRarity = filter.val.split("_")[2]; const rarityBypass = (filterRarity == '%');
                    const filterLevel = filter.val.split("_")[1]; const levelBypass = (filterLevel == '%');
                    const filterName = filter.val.split("_")[0]; const nameBypass = (filterName == '%');
                    const loadValue = await window.getShipDrops(loadedEid.value, mission.missionId);
                    if(loadValue == "") filterPassed = false;
                    const allDrops = JSON.parse(loadValue);
                    switch(filter.op){
                      case 'c':{ //Contains
                        var foundDrop = false;
                        if(!qualityBypass && maxQuality < filterQuality || !qualityBypass && durConfig.minQuality > filterQuality) filterPassed = false;
                        for(const drop of allDrops){
                          if(!nameBypass && parseInt(filterName) != drop.id ) continue;
                          if(!levelBypass && parseInt(filterLevel) != drop.level) continue;
                          if(!rarityBypass && parseInt(filterRarity) != drop.rarity) continue;
                          foundDrop = true;
                        }
                        if(!foundDrop) filterPassed = false;
                        break;
                      }
                      case 'dnc': { //Does not contain
                        for(const drop of allDrops){
                          if(!nameBypass && parseInt(filterName) != drop.id ) continue;
                          if(!levelBypass && parseInt(filterLevel) != drop.level) continue;
                          if(!rarityBypass && parseInt(filterRarity) != drop.rarity) continue;
                          filterPassed = false;
                        }
                      }
                    }
                  }
                }
                return filterPassed;
              } else return false;
            }

            const missionMatchesFilter = async (mission, filters, orFilters) => {
              var allFiltersPassed = true;
              var index = 0;
              for(const filter of filters){
                var filterPassed = true;
                if(filter.topLevel != null && filter.op != null && (filter.val != null || filter.topLevel == 'target' ) ){
                  filterPassed = await testMissionAgainstFilter(mission, filter);
                  if(!filterPassed) {
                    if(orFilters[index] != null){
                      for(const orFilter of orFilters[index]){
                        if(orFilter.topLevel != null && orFilter.op != null && (orFilter.val != null || orFilter.topLevel == 'target')){
                          filterPassed = await testMissionAgainstFilter(mission, orFilter);
                          if(filterPassed) break;
                        }
                      }
                    }
                    if(!filterPassed) allFiltersPassed = false;
                  }
                }
                index++;
              }
              return allFiltersPassed;
            }

            const applyFilter = async () => {
              //Start a timer to see how long it takes to apply the filter
              const startTime = performance.now();

              dataBeingFiltered.value = true;
              filterHasChanged.value = false;
              const newFilteredMissions = [];
              for(const loadedMission of allLoadedMissions.value){
                if(await missionMatchesFilter(loadedMission, dataFilter.value, orDataFilter.value)){
                  newFilteredMissions.push(loadedMission);
                }
              }

              //Stop the timer and calculate the time it took to apply the filter
              const endTime = performance.now();
              const applyTime = endTime - startTime;

              //Display the time it took to apply the filter in seconds and ms
              const seconds = Math.floor(applyTime / 1000);
              const ms = Math.floor(applyTime % 1000);
              filterApplyTime.value = seconds + "." + ms + "s";

              filteredMissions.value = newFilteredMissions;
              dataBeingFiltered.value = false;
            };

            const targetImage = (target) => {
              if(target == null || target == "" || target == "UNKNOWN") return "";
              else{
                target = target.toUpperCase().replaceAll("ORNATE_GUSSET", "GUSSET").replaceAll("VIAL_MARTIAN_DUST", "VIAL_OF_MARTIAN_DUST");; //Redundancy
                var tier = 4;
                if(target.indexOf('_FRAGMENT') > -1) {
                  target = target.replace('_FRAGMENT', '');
                  tier = 1;
                }
                if(target == 'GOLD_METEORITE' || target == 'TAU_CETI_GEODE' || target == 'SOLAR_TITANIUM') tier = 3;
                const path = "images/artifacts/" + target + "/" + target + "_" + tier + ".png";
                return [path, target];
              }
            };

            //Set it up so that if a click is performed outside of the 'viewMissionDiv', closeMissionOverlay() is called
            Vue.onMounted(() => {
              const largerDiv = document.getElementById('missionViewDiv');
              largerDiv.addEventListener('click', function(event) {
                if(this.classList.contains('hidden')) return;
                const innerDiv = document.getElementById('innerMissionViewDiv');
                const divRect = innerDiv.getBoundingClientRect();
                const clickX = event.clientX;
                const clickY = event.clientY;
                if(clickX < divRect.left || clickX > divRect.right || clickY < divRect.top || clickY > divRect.bottom) closeMissionOverlay();
              });
            });

            //Set it up so that if a click is performed outside of the 'dropSelectDiv', closeDropFilterMenu() is called
            Vue.onMounted(() => {
              const largerDiv = document.getElementById('dropSelectDiv');
              largerDiv.addEventListener('click', function(event) {
                if(this.classList.contains('hidden')) return;
                const innerDiv = document.getElementById('innerDropSelectDiv');
                const divRect = innerDiv.getBoundingClientRect();
                const clickX = event.clientX;
                const clickY = event.clientY;
                if(clickX < divRect.left || clickX > divRect.right || clickY < divRect.top || clickY > divRect.bottom) closeDropFilterMenu();
              });
            });

            //Set it up so that if a click is performed outside of the 'targetSelectDiv, closeTargetFilterMenu() is called
            Vue.onMounted(() => {
              const largerDiv = document.getElementById('targetSelectDiv');
              largerDiv.addEventListener('click', function(event) {
                if(this.classList.contains('hidden')) return;
                const innerDiv = document.getElementById('innerTargetSelectDiv');
                const divRect = innerDiv.getBoundingClientRect();
                const clickX = event.clientX;
                const clickY = event.clientY;
                if(clickX < divRect.left || clickX > divRect.right || clickY < divRect.top || clickY > divRect.bottom) closeTargetFilterMenu();
              });
            });

            const padNumber = (num) => {
              num = parseInt(num.toString()); //Make sure it's a number
              return (num < 10 ? '0' : '') + num;
            }

            const getSpecificMissionData = async (eid, missionId, extendedInfo) => {
              const shipInfoStr = await window.getShipInfo(eid, missionId);
              if(shipInfoStr == "") return null;
              const shipInfo = JSON.parse(shipInfoStr);

              const loadValue = await window.getShipDrops(eid, missionId);
              if(loadValue == "") return null;
              const allDrops = JSON.parse(loadValue);

              const artifacts = allDrops.filter(drop => drop.specType == "Artifact");
              const stones = allDrops.filter(drop => drop.specType == "Stone");
              const stoneFragments = allDrops.filter(drop => drop.specType == "StoneFragment");
              const ingredients = allDrops.filter(drop => drop.specType == "Ingredient");
              //Compute the duration in days, hours, minutes
              const commonProperties = {
                shipInfo: shipInfo,
                artifacts: sortedGroupedSpecType(artifacts),
                stones: sortedGroupedSpecType(stones),
                stoneFragments: sortedGroupedSpecType(stoneFragments),
                ingredients: sortedGroupedSpecType(ingredients),
                artifactCount: artifacts.length,
                stoneCount: stones.length,
                stoneFragmentCount: stoneFragments.length,
                ingredientCount: ingredients.length
              };

              if (extendedInfo) {
                const launchDateTime = new Date(
                  shipInfo.launchYear, shipInfo.launchMonth, shipInfo.launchDay,
                  shipInfo.launchTime.split(':')[0], shipInfo.launchTime.split(':')[1], shipInfo.launchTime.split(':')[2]
                );
                const returnDateTime = new Date(
                  shipInfo.returnYear, shipInfo.returnMonth, shipInfo.returnDay,
                  shipInfo.returnTime.split(':')[0], shipInfo.returnTime.split(':')[1], shipInfo.returnTime.split(':')[2]
                );
                const duration = returnDateTime - launchDateTime;
                const days = Math.floor(duration / (1000 * 60 * 60 * 24));
                const hours = Math.floor((duration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                const durationString = (days > 0 ? days + "d" : "") + (hours > 0 ? hours + "h": "") + minutes + "m";
                const launchStr = shipInfo.launchYear + '-' + padNumber(shipInfo.launchMonth) + '-' + padNumber(shipInfo.launchDay) + ' ' + shipInfo.launchTime;
                const returnStr = shipInfo.returnYear + '-' + padNumber(shipInfo.returnMonth) + '-' + padNumber(shipInfo.returnDay) + ' ' + shipInfo.returnTime;

                // Find the loaded ship's index in the filteredMissions array, to get the missions directly before and after it
                const shipIndex = filteredMissions.value.findIndex(mission => mission.missionId == missionId);
                const prevMission = shipIndex > 0 ? filteredMissions.value[shipIndex - 1].missionId : null;
                const nextMission = shipIndex < filteredMissions.value.length - 1 ? filteredMissions.value[shipIndex + 1].missionId : null;

                const capModifier = Math.min(2, shipInfo.capacity / shipInfo.nominalCapacity);

                return {
                  ...commonProperties,
                  launchStr: launchStr,
                  returnStr: returnStr,
                  durationStr: durationString,
                  prevMission: prevMission,
                  nextMission: nextMission,
                  capacityModifier: capModifier,
                };
              } else return commonProperties;
            };

            const missionBeingViewed = Vue.ref(null);
            const viewSpecificMission = async (missionId) => {
              //Do not allow viewing a mission while data is being fetched - prevent collisions
              if(isFetching.value) return false; 
              const newMissionViewData = await getSpecificMissionData(loadedEid.value, missionId, true);
              if(newMissionViewData == null) return false;
              missionBeingViewed.value = missionId;
              viewMissionData.value = newMissionViewData;
              openMissionOverlay();
            };

            return {
              appVersion,
              appDirectory,
              appIsInForbiddenDirectory,
              appIsTranslocated,

              UITab,
              AppState,

              activeTab,

              knownAccounts,
              playerId,
              isPlayerIdValid,
              nicknameForSelectedPlayerId,
              playerIdSelectRef,
              playerIdInputRef,
              playerIdSubmitRef,
              playerIdDropdownOpen,
              getEidProblem,
              openPlayerIdDropdown,
              closePlayerIdDropdown,
              selectPlayerId,
              fetchPlayerData,
              stopFetchingPlayerData,

              currentState,
              idle,
              missionProgress,
              exportedFiles,

              messagesRef,
              messages,
              extractColorSegments,
              hhmmss,

              appHasUpdate,

              //Lifetime data
              LifetimeLoadState,
              selectedLifetimeAccount,
              lifetimeAccountSelectRef,
              lifetimeAccountInputRef,
              openLifetimeAccountDropdown,
              closeLifetimeAccountDropdown,
              lifetimeAccountDropdownOpen,
              selectLifetimeAccount,
              lifetimeAccountSubmitRef,
              lifetimeDrops,
              lifetimeDropsBeingLoaded,
              lifetimeDropsLoadedProgress,
              viewLifetimeDropsOfEid,
              lifetimeState,

              //View all missions
              doesDataExist,
              existingData,
              objectedExistingData,
              selectedMissionAccount,
              eidMissionsBeingLoaded,
              viewMissionAccountInputRef,
              viewMissionAccountSelectRef,
              viewMissionAccountDropdownOpen,
              viewMissionAccountSubmitRef,
              missionBeingViewed,
              viewMissionsOfEid,
              toggleElements,
              padDateOut,
              shipToName,
              viewSpecificMission,
              targetImage,
              closeMissionOverlay,
              refreshExistingData,
              openMissionsViewAccountDropdown,
              selectViewAccount,
              closeMissionsViewAccountDropdown,

              //View specific mission
              viewByDate,
              viewMissionTimes,
              recolorDC,
              useGifsForRarity,
              loadedAccountMissionsCount,
              loadedEid,
              allLoadedMissions,
              filteredMissions,
              groupedMissions,
              possibleTargets,
              maxQuality,
              durationConfigs,
              artifactConfigs,
              boundEffectString,
              afRarityClass,
              afRarityText,
              afBackgroundClass,
              afExplorerName,
              specPath,
              dropPath,
              dropRarityPath,
              groupedSpecType,
              numToDigClass,
              properCase,
              durToTextClass,
              viewMissionData,
              groupedYearArray,
              groupedMonthArray,
              groupedDayArray,
              allVisible,

              //Filter
              dataFilter,
              dataBeingFiltered,
              filterApplyTime,
              filterHasChanged,
              hideFilter,
              topLevelFilterOptions,
              filterOperators,
              filterValues,
              orFilterConditionsCount,
              orFilterTopLevelOptions,
              orFilterOperators,
              orFilterValues,
              addOr,
              applyFilter,
              handleFilterChange,
              handleOrFilterChange,
              manualChangeFilter,
              updateFilterConditionsCount,
              updateValueStyling,
              updateFilterNoReCount,
              getTopLevelFilterOptions,
              getFilterOpOptions,
              getFilterValueOptions,
              removeAndShift,
              removeOrAndShift,
              generateFilterConditionsArr,
              generateOrFiltersConditionsArr,
              calculateMaxMissionDivHeight,
              filterWarningRead,
              hideFilterWarning,
              dismissFilterWarning,
              dropFilterSelectedIndex,
              dropFilterMenuOpen,
              dropSelectList,
              dropFilterSelectedOrIndex,
              dropSearchTerm,
              dFilterValues,
              dOrFilterValues,
              openDropFilterMenu,
              closeDropFilterMenu,
              selectDropFilter,
              isBaseFilter,
              targetSelectList,
              targetFilterSelectedIndex,
              targetFilterSelectedOrIndex,
              targetFilterMenuOpen,
              openTargetFilterMenu,
              closeTargetFilterMenu,
              selectTargetFilter,
              targetSearchTerm,

              openFile: window.openFile,
              openFileInFolder: window.openFileInFolder,
              openURL: window.openURL,
            };
          },
        });

        app.directive('unhide', {
          mounted(el) {
            el.style.display = '';
          },
        });

        // <a v-external-link> opens the link in the default browser rather than the in-app browser.
        app.directive('external-link', {
          mounted(el) {
            el.addEventListener('click', event => {
              event.preventDefault();
              window.openURL(el.href);
            });
          },
        });

        app.mount('#app');
      })();
    </script>
  </body>
</html>
